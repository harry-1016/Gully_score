<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ff6b35">
    <meta name="description" content="Live cricket scoring app">
    <link rel="manifest" href="manifest-public.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>GULLY SCORE - Live Cricket</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&display=swap');

```
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        min-height: 100vh;
    }

    .container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        min-height: 100vh;
        box-shadow: 0 0 50px rgba(0,0,0,0.3);
    }

    .app-header {
        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        padding: 25px 20px 20px 20px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .app-name {
        font-family: 'Bangers', cursive;
        font-size: 48px;
        color: white;
        text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
        letter-spacing: 3px;
        margin-bottom: 5px;
    }

    .app-tagline {
        color: white;
        font-size: 12px;
        opacity: 0.9;
        font-weight: 300;
    }

    .screen {
        display: none;
        padding: 20px;
    }

    .screen.active {
        display: block;
    }

    .section-title {
        font-size: 20px;
        font-weight: bold;
        color: #333;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 3px solid #ff6b35;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .match-card {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: all 0.3s;
    }

    .match-card:hover {
        border-color: #ff6b35;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }

    .match-teams {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .team-name {
        font-weight: bold;
        color: #333;
        font-size: 16px;
    }

    .vs-text {
        color: #666;
        font-size: 14px;
    }

    .match-score {
        font-size: 20px;
        color: #ff6b35;
        font-weight: bold;
    }

    .match-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 8px;
    }

    .overs-text {
        color: #666;
        font-size: 14px;
    }

    .live-badge {
        display: inline-block;
        background: #dc3545;
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
        animation: blink 1.5s infinite;
    }

    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .completed-badge {
        display: inline-block;
        background: #28a745;
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
    }

    .no-matches {
        text-align: center;
        color: #999;
        padding: 40px 20px;
        font-size: 14px;
    }

    .no-matches-icon {
        font-size: 60px;
        margin-bottom: 15px;
    }

    .scorecard-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .scorecard-header {
        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        color: white;
        padding: 20px;
        text-align: center;
    }

    .scorecard-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .scorecard-subtitle {
        font-size: 14px;
        opacity: 0.9;
    }

    .scorecard-section {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
    }

    .scorecard-section:last-child {
        border-bottom: none;
    }

    .section-heading {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 16px;
        font-weight: bold;
        color: #ff6b35;
        margin-bottom: 15px;
    }

    .main-score-display {
        text-align: center;
        padding: 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 8px;
    }

    .innings-label {
        font-size: 14px;
        color: #666;
        margin-bottom: 8px;
    }

    .score-large {
        font-size: 48px;
        font-weight: bold;
        color: #ff6b35;
        margin: 10px 0;
    }

    .overs-large {
        font-size: 16px;
        color: #666;
    }

    .stats-table {
        width: 100%;
        border-collapse: collapse;
    }

    .stats-table th {
        background: #f8f9fa;
        padding: 10px 8px;
        text-align: left;
        font-size: 12px;
        color: #666;
        font-weight: 600;
        border-bottom: 2px solid #e0e0e0;
    }

    .stats-table td {
        padding: 12px 8px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 14px;
    }

    .stats-table tr:last-child td {
        border-bottom: none;
    }

    .player-name {
        font-weight: 500;
        color: #333;
    }

    .stats-highlight {
        background: #fff3e0;
    }

    .out-status {
        display: inline-block;
        background: #dc3545;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: bold;
        margin-left: 5px;
    }

    .not-out {
        display: inline-block;
        background: #28a745;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: bold;
        margin-left: 5px;
    }

    .balls-container {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
        padding: 10px;
    }

    .ball-dot {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
        background: #e0e0e0;
        color: #333;
    }

    .ball-dot.dot { background: #6c757d; color: white; }
    .ball-dot.one, .ball-dot.two, .ball-dot.three { background: #28a745; color: white; }
    .ball-dot.four { background: #007bff; color: white; }
    .ball-dot.six { background: #9c27b0; color: white; }
    .ball-dot.wicket { background: #dc3545; color: white; }
    .ball-dot.wide, .ball-dot.noball { background: #ffc107; color: #333; }

    .share-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        color: white;
        border: none;
        padding: 15px 25px;
        border-radius: 50px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 5px 25px rgba(255, 107, 53, 0.5);
        transition: all 0.3s;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .share-button:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 30px rgba(255, 107, 53, 0.7);
    }

    .share-button:active { transform: scale(0.95); }

    .share-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }

    .share-modal.active { display: flex; }

    .share-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        max-width: 400px;
        width: 90%;
    }

    .share-options {
        display: grid;
        gap: 15px;
        margin-top: 20px;
    }

    .share-option {
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
        font-weight: bold;
    }

    .share-option:hover {
        border-color: #ff6b35;
        background: #fff5f0;
    }

    /* FIX 2: Collapsible innings toggle styles */
    .innings-toggle {
        width: 100%;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 2px solid #dee2e6;
        border-radius: 10px;
        padding: 14px 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        font-size: 15px;
        font-weight: bold;
        color: #333;
        transition: all 0.3s;
        margin-bottom: 0;
    }

    .innings-toggle:hover {
        border-color: #ff6b35;
        background: #fff5f0;
        color: #ff6b35;
    }

    .innings-toggle .toggle-arrow {
        font-size: 18px;
        transition: transform 0.3s;
    }

    .innings-toggle.collapsed .toggle-arrow {
        transform: rotate(-90deg);
    }

    .innings-collapsible {
        overflow: hidden;
        transition: max-height 0.4s ease, opacity 0.3s ease;
        max-height: 2000px;
        opacity: 1;
    }

    .innings-collapsible.collapsed {
        max-height: 0;
        opacity: 0;
    }

    .innings-toggle-wrapper {
        padding: 15px 20px;
        border-bottom: 1px solid #e0e0e0;
    }

    /* Chase card - prominent blue box for live 2nd innings */
    .chase-card {
        background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
        border-radius: 12px;
        padding: 18px 20px;
        text-align: center;
        margin-top: 14px;
        border: 1px solid #bfdbfe;
    }

    .chase-runs {
        font-size: 24px;
        font-weight: bold;
        color: #1d4ed8;
        margin-bottom: 4px;
    }

    .chase-balls {
        font-size: 15px;
        color: #4b5563;
    }

    /* Winner banner for completed matches */
    .winner-banner {
        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        color: white;
        text-align: center;
        padding: 18px 20px;
        margin: 0;
    }

    .winner-banner .trophy {
        font-size: 30px;
        margin-bottom: 6px;
    }

    .winner-banner .winner-text {
        font-size: 20px;
        font-weight: bold;
        letter-spacing: 0.5px;
    }

    /* ‚îÄ‚îÄ Player name clickable link style ‚îÄ‚îÄ */
    .player-name-link {
        cursor: pointer;
        color: #333;
        border-bottom: 1.5px dashed #ff6b35;
        transition: color 0.2s;
        display: inline;
    }
    .player-name-link:hover { color: #ff6b35; }

    /* ‚îÄ‚îÄ Player Profile Screen ‚îÄ‚îÄ */
    #playerScreen { padding: 0; }

    .profile-header {
        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        color: white;
        padding: 24px 20px 20px;
        text-align: center;
    }

    .profile-avatar {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        background: rgba(255,255,255,0.25);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 34px;
        margin: 0 auto 12px;
        border: 3px solid rgba(255,255,255,0.5);
    }

    .profile-name {
        font-size: 24px;
        font-weight: bold;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .profile-back {
        cursor: pointer;
        font-size: 13px;
        opacity: 0.85;
        margin-bottom: 10px;
        display: inline-block;
    }
    .profile-back:hover { opacity: 1; }

    .profile-body { padding: 20px; }

    /* Career summary cards */
    .career-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 24px;
    }

    .career-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 16px 12px;
        text-align: center;
        border: 2px solid #e0e0e0;
    }

    .career-card-label {
        font-size: 11px;
        color: #888;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
    }

    .career-card-value {
        font-size: 26px;
        font-weight: bold;
        color: #ff6b35;
    }

    .career-card-sub {
        font-size: 11px;
        color: #999;
        margin-top: 3px;
    }

    /* Section tabs */
    .profile-tabs {
        display: flex;
        gap: 0;
        border-radius: 10px;
        overflow: hidden;
        border: 2px solid #e0e0e0;
        margin-bottom: 20px;
    }

    .profile-tab {
        flex: 1;
        padding: 11px 8px;
        text-align: center;
        font-weight: bold;
        font-size: 14px;
        cursor: pointer;
        background: white;
        color: #666;
        border: none;
        transition: all 0.2s;
    }

    .profile-tab.active {
        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        color: white;
    }

    .profile-tab-content { display: none; }
    .profile-tab-content.active { display: block; }

    /* Per-match history rows */
    .match-history-row {
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 12px 14px;
        margin-bottom: 10px;
        background: white;
    }

    .match-history-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .match-history-teams {
        font-size: 13px;
        font-weight: bold;
        color: #333;
    }

    .match-history-date {
        font-size: 11px;
        color: #999;
    }

    .match-history-stats {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .stat-pill {
        background: #f8f9fa;
        border-radius: 20px;
        padding: 4px 10px;
        font-size: 12px;
        font-weight: 600;
        color: #555;
        border: 1px solid #e0e0e0;
    }

    .stat-pill.highlight { background: #fff3e0; border-color: #ff6b35; color: #ff6b35; }
    .stat-pill.wicket { background: #fff5f5; border-color: #dc3545; color: #dc3545; }

    .profile-loading {
        text-align: center;
        padding: 40px 20px;
        color: #999;
        font-size: 15px;
    }

    .profile-empty {
        text-align: center;
        padding: 30px 20px;
        color: #bbb;
        font-size: 14px;
    }
</style>
```

</head>
<body>
    <div class="container">
        <div class="app-header">
            <div class="app-name">GULLY SCORE</div>
            <div class="app-tagline">made with ‚ù§Ô∏è harry goud</div>
        </div>

```
    <div id="homeScreen" class="screen active">
        <div class="section-title">
            <span>üî¥</span>
            <span>Live Matches</span>
        </div>
        <div id="liveMatchesList">
            <div class="no-matches">
                <div class="no-matches-icon">üèè</div>
                Loading...
            </div>
        </div>

        <div class="section-title" style="margin-top: 30px;">
            <span>‚úÖ</span>
            <span>Recent Matches</span>
        </div>
        <div id="recentMatchesList">
            <div class="no-matches">
                <div class="no-matches-icon">üìã</div>
                Loading...
            </div>
        </div>
    </div>

    <div id="scorecardScreen" class="screen"></div>

    <!-- Player Profile Screen -->
    <div id="playerScreen" class="screen"></div>
</div>

<!-- Share Modal -->
<div id="shareModal" class="share-modal" onclick="if(event.target === this) closeShareModal()">
    <div class="share-content">
        <h3 style="margin: 0 0 20px 0; color: #333; font-size: 22px; text-align: center;">Share Scorecard</h3>
        <div class="share-options">
            <div class="share-option" onclick="shareNative()" style="background: #007bff; color: white; border-color: #007bff;">
                üì± Share
            </div>
            <div class="share-option" onclick="shareViaWhatsApp()" style="background: #25D366; color: white; border-color: #25D366;">
                üí¨ WhatsApp
            </div>
            <div class="share-option" onclick="shareViaTelegram()" style="background: #0088cc; color: white; border-color: #0088cc;">
                ‚úàÔ∏è Telegram
            </div>
            <div class="share-option" onclick="shareViaTwitter()" style="background: #1DA1F2; color: white; border-color: #1DA1F2;">
                üê¶ Twitter / X
            </div>
            <div class="share-option" onclick="copyToClipboard()">
                üìã Copy to Clipboard
            </div>
        </div>
        <button onclick="closeShareModal()" style="width: 100%; margin-top: 20px; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
            Cancel
        </button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCpV2GXvuCog7bTQoutpOoQovGvtYeqclw",
        authDomain: "gully-score.firebaseapp.com",
        databaseURL: "https://gully-score-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "gully-score",
        storageBucket: "gully-score.firebasestorage.app",
        messagingSenderId: "305069405268",
        appId: "1:305069405268:web:f368add1f10132bee829c1"
    };

    let database;
    let liveMatchesListener;
    // FIX 3: Track active scorecard listener and current match ID
    let scorecardListener = null;
    let currentMatchId = null;

    function init() {
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            database = firebase.database();
            console.log('Firebase initialized successfully');
            setupRealtimeListeners();
        } catch (error) {
            console.error('Firebase initialization error:', error);
            showError();
        }
    }

    function setupRealtimeListeners() {
        liveMatchesListener = database.ref('matches').on('value', (snapshot) => {
            const matches = snapshot.val();
            displayMatches(matches);
        }, (error) => {
            console.error('Error fetching matches:', error);
            showError();
        });
    }

    function displayMatches(matches) {
        const liveContainer = document.getElementById('liveMatchesList');
        const recentContainer = document.getElementById('recentMatchesList');
        
        let liveHTML = '';
        let recentHTML = '';
        let hasLive = false;
        let hasRecent = false;

        if (matches) {
            Object.keys(matches).forEach(matchId => {
                const match = matches[matchId];
                const matchCard = createMatchCard(match, matchId);
                
                if (match.matchStatus === 'live') {
                    liveHTML += matchCard;
                    hasLive = true;
                } else if (match.matchStatus === 'completed') {
                    recentHTML += matchCard;
                    hasRecent = true;
                }
            });
        }

        liveContainer.innerHTML = hasLive ? liveHTML : 
            '<div class="no-matches"><div class="no-matches-icon">üèè</div>No live matches</div>';
        
        recentContainer.innerHTML = hasRecent ? recentHTML : 
            '<div class="no-matches"><div class="no-matches-icon">üìã</div>No recent matches</div>';
    }

    function createMatchCard(match, matchId) {
        const team1 = match.teamA.name;
        const team2 = match.teamB.name;
        const battingTeam = match.battingTeam.name;
        const score = `${match.score}/${match.wickets}`;
        const overs = `${match.currentOver}.${match.currentBall}`;
        const statusBadge = match.matchStatus === 'live' 
            ? '<span class="live-badge">‚óè LIVE</span>' 
            : '<span class="completed-badge">COMPLETED</span>';

        return `
            <div class="match-card" onclick="showScorecard('${matchId}')">
                <div class="match-teams">
                    <span class="team-name">${team1}</span>
                    <span class="vs-text">vs</span>
                    <span class="team-name">${team2}</span>
                </div>
                <div class="match-info">
                    <div>
                        <div class="match-score">${battingTeam}: ${score}</div>
                        <div class="overs-text">Overs: ${overs}/${match.overs}</div>
                    </div>
                    ${statusBadge}
                </div>
            </div>
        `;
    }

    function showScorecard(matchId) {
        // FIX 3: Stop any existing scorecard listener before starting a new one
        stopScorecardListener();
        currentMatchId = matchId;

        // Show screen first
        document.getElementById('homeScreen').classList.remove('active');
        document.getElementById('scorecardScreen').classList.add('active');

        // FIX 3: Use real-time listener instead of once() so live matches stay updated
        scorecardListener = database.ref('matches/' + matchId).on('value', (snapshot) => {
            const match = snapshot.val();
            if (match) {
                renderScorecard(match);
            }
        });
    }

    function stopScorecardListener() {
        if (scorecardListener !== null && currentMatchId !== null) {
            database.ref('matches/' + currentMatchId).off('value', scorecardListener);
            scorecardListener = null;
        }
        currentMatchId = null;
    }

    function toggleInnings(id) {
        const content = document.getElementById(id);
        const btn = document.getElementById('btn-' + id);
        if (content && btn) {
            content.classList.toggle('collapsed');
            btn.classList.toggle('collapsed');
        }
    }

    function renderScorecard(match) {
        const container = document.getElementById('scorecardScreen');
        
        // FIX 2: Remember which innings toggle was open/closed before re-render
        const firstInningsContent = document.getElementById('firstInningsContent');
        const wasCollapsed = firstInningsContent ? firstInningsContent.classList.contains('collapsed') : false;

        const innings1BattingTeam = match.firstInningsBattingTeam === 'teamA' ? match.teamA : match.teamB;
        const innings1BowlingTeam = match.firstInningsBattingTeam === 'teamA' ? match.teamB : match.teamA;

        let html = `
            <div class="scorecard-container">
                <div class="scorecard-header">
                    <div class="scorecard-title">${match.teamA.name} vs ${match.teamB.name}</div>
                    <div class="scorecard-subtitle" onclick="goBack()" style="cursor: pointer; margin-top: 10px;">‚Üê Back</div>
                </div>
        `;

        // FIX 2: 1st innings as collapsible toggle (only shown if 2nd innings is ongoing/done)
        if (match.innings === 2 && match.firstInningsScore !== undefined) {
            const collapsedClass = wasCollapsed ? 'collapsed' : '';
            html += `
                <div class="innings-toggle-wrapper">
                    <button class="innings-toggle ${collapsedClass}" id="btn-firstInningsContent" onclick="toggleInnings('firstInningsContent')">
                        <span>üèè 1st Innings ‚Äî ${innings1BattingTeam.name}: ${match.firstInningsScore}/${match.firstInningsWickets} (${match.firstInningsOvers || match.overs} ov)</span>
                        <span class="toggle-arrow">‚ñº</span>
                    </button>
                </div>
                <div class="innings-collapsible ${collapsedClass}" id="firstInningsContent">
                    <div class="scorecard-section">
                        <div class="main-score-display">
                            <div class="innings-label">1st Innings - ${innings1BattingTeam.name}</div>
                            <div class="score-large">${match.firstInningsScore}/${match.firstInningsWickets}</div>
                            <div class="overs-large">Overs: ${match.firstInningsOvers || match.overs}</div>
                        </div>
                    </div>
            `;

            const battingPlayers1st = match.firstInningsBatting ? match.firstInningsBatting.filter(p => p.balls > 0 || p.isOut || p.isRetired) : [];
            const bowlingPlayers1st = match.firstInningsBowling || [];

            if (battingPlayers1st.length > 0) {
                html += `
                    <div class="scorecard-section">
                        <div class="section-heading">
                            <span>üèè</span>
                            <span>Batting - ${innings1BattingTeam.name}</span>
                        </div>
                        <table class="stats-table">
                            <thead>
                                <tr>
                                    <th>Batsman</th>
                                    <th style="text-align: center;">R</th>
                                    <th style="text-align: center;">B</th>
                                    <th style="text-align: center;">4s</th>
                                    <th style="text-align: center;">6s</th>
                                    <th style="text-align: center;">SR</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${battingPlayers1st.map(player => {
                                    const sr = player.balls > 0 ? ((player.runs / player.balls) * 100).toFixed(1) : '0.0';
                                    let dismissalLabel = player.dismissal || 'OUT';
                                    if ((player.dismissal === 'Caught' || player.dismissal === 'Stumped') && player.dismissalFielder) dismissalLabel += ' ' + player.dismissalFielder;
                                    if (player.dismissal === 'Run Out' && player.dismissalFielder) dismissalLabel += ' (' + player.dismissalFielder + ')';
                                    return `
                                        <tr>
                                            <td class="player-name">
                                                <span class="player-name-link" onclick="showPlayerProfile('${player.name.replace(/'/g,"\\'")}','scorecardScreen')">${player.name}</span>
                                                ${player.isOut ? `<div class="out-status" title="${dismissalLabel}">${dismissalLabel}</div>` :
                                                  player.isRetired ? `<div class="out-status" style="background:#ff9800;">${player.retiredType||'RETIRED'}</div>` :
                                                  '<div class="not-out">NOT OUT</div>'}
                                            </td>
                                            <td style="text-align: center; font-weight: bold;">${player.runs}</td>
                                            <td style="text-align: center;">${player.balls}</td>
                                            <td style="text-align: center;">${player.fours || 0}</td>
                                            <td style="text-align: center;">${player.sixes || 0}</td>
                                            <td style="text-align: center;">${sr}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            if (bowlingPlayers1st.length > 0) {
                html += `
                    <div class="scorecard-section">
                        <div class="section-heading">
                            <span>‚öæ</span>
                            <!-- FIX 1: Show the BOWLING team (innings1BowlingTeam), not batting team -->
                            <span>Bowling - ${innings1BowlingTeam.name}</span>
                        </div>
                        <table class="stats-table">
                            <thead>
                                <tr>
                                    <th>Bowler</th>
                                    <th style="text-align: center;">O</th>
                                    <th style="text-align: center;">R</th>
                                    <th style="text-align: center;">W</th>
                                    <th style="text-align: center;">Econ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${bowlingPlayers1st.map(player => {
                                    const overs = Math.floor(player.bowlingBalls / 6);
                                    const balls = player.bowlingBalls % 6;
                                    const oversStr = `${overs}.${balls}`;
                                    const totalOvers = player.bowlingBalls / 6;
                                    const econ = totalOvers > 0 ? (player.bowlingRuns / totalOvers).toFixed(2) : '0.00';
                                    return `
                                        <tr>
                                            <td class="player-name"><span class="player-name-link" onclick="showPlayerProfile('${player.name.replace(/'/g,"\\'")}','scorecardScreen')">${player.name}</span></td>
                                            <td style="text-align: center;">${oversStr}</td>
                                            <td style="text-align: center; font-weight: bold;">${player.bowlingRuns}</td>
                                            <td style="text-align: center; font-weight: bold; color: #dc3545;">${player.bowlingWickets}</td>
                                            <td style="text-align: center;">${econ}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            html += `</div>`; // close innings-collapsible
        }

        // Winner banner for completed matches
        if (match.matchStatus === 'completed' && match.innings === 2) {
            const target = match.firstInningsScore + 1;
            let resultText = '';
            if (match.score >= target) {
                resultText = `üèÜ ${match.battingTeam.name} won by ${10 - match.wickets} wickets`;
            } else {
                resultText = `üèÜ ${match.bowlingTeam.name} won by ${target - match.score - 1} runs`;
            }
            html += `<div class="winner-banner"><div class="winner-text">${resultText}</div></div>`;
        }

        // Current / 2nd innings score
        const inningsSuffix = match.innings === 1 ? 'st' : 'nd';
        const totalBallsInMatch = match.overs * 6;
        const ballsBowled = (match.currentOver * 6) + match.currentBall;
        const ballsRemaining = Math.max(0, totalBallsInMatch - ballsBowled);
        const runsNeeded = match.innings === 2 ? Math.max(0, match.firstInningsScore + 1 - match.score) : 0;

        html += `
            <div class="scorecard-section">
                <div class="main-score-display">
                    <div class="innings-label">
                        ${inningsSuffix} Innings - ${match.battingTeam.name}
                    </div>
                    <div class="score-large">
                        ${match.score}/${match.wickets}
                    </div>
                    <div class="overs-large">
                        Overs: ${match.currentOver}.${match.currentBall} / ${match.overs}
                    </div>
                    ${match.matchStatus === 'live' ? '<div style="margin-top: 10px;"><span class="live-badge">‚óè LIVE</span></div>' : ''}
                    ${match.matchStatus === 'live' && match.innings === 2 ? `
                        <div class="chase-card">
                            <div class="chase-runs">Need ${runsNeeded} runs to win</div>
                            <div class="chase-balls">${ballsRemaining} ball${ballsRemaining !== 1 ? 's' : ''} remaining</div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        // For completed matches, battingTeam.players may be empty ‚Äî fall back to secondInningsBatting/Bowling
        const battingTeamPlayers = (match.battingTeam.players && match.battingTeam.players.filter(p => p.balls > 0 || p.isOut || p.isRetired).length > 0)
            ? match.battingTeam.players.filter(p => p.balls > 0 || p.isOut || p.isRetired)
            : (match.secondInningsBatting ? match.secondInningsBatting.filter(p => p.balls > 0 || p.isOut || p.isRetired) : []);

        const bowlingTeamPlayers = (match.bowlingTeam.players && match.bowlingTeam.players.filter(p => p.bowlingBalls > 0).length > 0)
            ? match.bowlingTeam.players.filter(p => p.bowlingBalls > 0)
            : (match.secondInningsBowling ? match.secondInningsBowling.filter(p => p.bowlingBalls > 0) : []);
        
        if (battingTeamPlayers.length > 0) {
            html += `
                <div class="scorecard-section">
                    <div class="section-heading">
                        <span>üèè</span>
                        <span>${match.innings === 2 ? '2nd Innings ' : ''}Batting - ${match.battingTeam.name}</span>
                    </div>
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>Batsman</th>
                                <th style="text-align: center;">R</th>
                                <th style="text-align: center;">B</th>
                                <th style="text-align: center;">4s</th>
                                <th style="text-align: center;">6s</th>
                                <th style="text-align: center;">SR</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${battingTeamPlayers.map(player => {
                                const sr = player.balls > 0 ? ((player.runs / player.balls) * 100).toFixed(1) : '0.0';
                                const isStriker = match.striker && player.name === match.striker.name;
                                let dismissalLabel = player.dismissal || 'OUT';
                                if ((player.dismissal === 'Caught' || player.dismissal === 'Stumped') && player.dismissalFielder) dismissalLabel += ' ' + player.dismissalFielder;
                                if (player.dismissal === 'Run Out' && player.dismissalFielder) dismissalLabel += ' (' + player.dismissalFielder + ')';
                                return `
                                    <tr ${isStriker ? 'class="stats-highlight"' : ''}>
                                        <td class="player-name">
                                            <span class="player-name-link" onclick="showPlayerProfile('${player.name.replace(/'/g,"\\'")}','scorecardScreen')">${player.name}</span>${isStriker ? ' *' : ''}
                                            ${player.isOut ?
                                                `<div class="out-status" title="${dismissalLabel}">${dismissalLabel}</div>` :
                                                player.isRetired ?
                                                `<div class="out-status" style="background:#ff9800;">${player.retiredType||'RETIRED'}</div>` :
                                                (player.balls > 0 ? '<div class="not-out">NOT OUT</div>' : '')
                                            }
                                        </td>
                                        <td style="text-align: center; font-weight: bold;">${player.runs}</td>
                                        <td style="text-align: center;">${player.balls}</td>
                                        <td style="text-align: center;">${player.fours || 0}</td>
                                        <td style="text-align: center;">${player.sixes || 0}</td>
                                        <td style="text-align: center;">${sr}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        if (bowlingTeamPlayers.length > 0) {
            html += `
                <div class="scorecard-section">
                    <div class="section-heading">
                        <span>‚öæ</span>
                        <!-- FIX 1: Show the BOWLING team name (match.bowlingTeam.name), not batting team -->
                        <span>${match.innings === 2 ? '2nd Innings ' : ''}Bowling - ${match.bowlingTeam.name}</span>
                    </div>
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>Bowler</th>
                                <th style="text-align: center;">O</th>
                                <th style="text-align: center;">R</th>
                                <th style="text-align: center;">W</th>
                                <th style="text-align: center;">Econ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${bowlingTeamPlayers.map(player => {
                                const overs = Math.floor(player.bowlingBalls / 6);
                                const balls = player.bowlingBalls % 6;
                                const oversStr = `${overs}.${balls}`;
                                const totalOvers = player.bowlingBalls / 6;
                                const econ = totalOvers > 0 ? (player.bowlingRuns / totalOvers).toFixed(2) : '0.00';
                                const isBowling = match.bowler && player.name === match.bowler.name;
                                return `
                                    <tr ${isBowling ? 'class="stats-highlight"' : ''}>
                                        <td class="player-name"><span class="player-name-link" onclick="showPlayerProfile('${player.name.replace(/'/g,"\\'")}','scorecardScreen')">${player.name}</span>${isBowling ? ' *' : ''}</td>
                                        <td style="text-align: center;">${oversStr}</td>
                                        <td style="text-align: center; font-weight: bold;">${player.bowlingRuns}</td>
                                        <td style="text-align: center; font-weight: bold; color: #dc3545;">${player.bowlingWickets}</td>
                                        <td style="text-align: center;">${econ}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        if (match.matchStatus === 'live' && match.overBalls && match.overBalls.length > 0) {
            html += `
                <div class="scorecard-section">
                    <div class="section-heading">
                        <span>üìä</span>
                        <span>Current Over</span>
                    </div>
                    <div class="balls-container">
                        ${match.overBalls.map(ball => 
                            `<div class="ball-dot ${ball.class}">${ball.value}</div>`
                        ).join('')}
                    </div>
                </div>
            `;
        }

        html += '</div>';
        html += `
            <button class="share-button" onclick="openShareModal()">
                <span>üì§</span>
                <span>Share</span>
            </button>
        `;
        
        container.innerHTML = html;
        window.currentMatch = match;
    }

    function goBack() {
        // FIX 3: Stop live listener when going back
        stopScorecardListener();
        document.getElementById('scorecardScreen').classList.remove('active');
        document.getElementById('homeScreen').classList.add('active');
    }

    function openShareModal() {
        document.getElementById('shareModal').classList.add('active');
    }

    function closeShareModal() {
        document.getElementById('shareModal').classList.remove('active');
    }

    function generateShareText(match) {
        let text = `üèè ${match.teamA.name} vs ${match.teamB.name}\n\n`;
        
        if (match.matchStatus === 'completed' && match.innings === 2) {
            const target = match.firstInningsScore + 1;
            let result = '';
            if (match.score >= target) {
                result = `${match.battingTeam.name} won by ${10 - match.wickets} wickets`;
            } else {
                result = `${match.bowlingTeam.name} won by ${target - match.score - 1} runs`;
            }
            text += `üèÜ ${result}\n\n`;
        }
        
        text += `1st Innings: ${match.firstInningsScore}/${match.firstInningsWickets} (${match.firstInningsOvers || match.overs})\n`;
        text += `2nd Innings: ${match.score}/${match.wickets} (${match.currentOver}.${match.currentBall})\n\n`;
        text += `Powered by GULLY SCORE üèè`;
        
        return text;
    }

    function shareViaWhatsApp() {
        const text = generateShareText(window.currentMatch);
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        closeShareModal();
    }

    function shareViaTelegram() {
        const text = generateShareText(window.currentMatch);
        window.open(`https://t.me/share/url?text=${encodeURIComponent(text)}`, '_blank');
        closeShareModal();
    }

    function shareViaTwitter() {
        const text = generateShareText(window.currentMatch);
        window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`, '_blank');
        closeShareModal();
    }

    async function copyToClipboard() {
        const text = generateShareText(window.currentMatch);
        try {
            await navigator.clipboard.writeText(text);
            alert('Scorecard copied to clipboard!');
            closeShareModal();
        } catch (err) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                alert('Scorecard copied to clipboard!');
                closeShareModal();
            } catch (err2) {
                alert('Failed to copy. Please try again.');
            }
            document.body.removeChild(textArea);
        }
    }

    async function shareNative() {
        const text = generateShareText(window.currentMatch);
        if (navigator.share) {
            try {
                await navigator.share({
                    title: `${window.currentMatch.teamA.name} vs ${window.currentMatch.teamB.name}`,
                    text: text
                });
                closeShareModal();
            } catch (err) {
                if (err.name !== 'AbortError') console.error('Error sharing:', err);
            }
        } else {
            alert('Sharing not supported on this device. Use other share options.');
        }
    }

    function showError() {
        const errorMsg = `<div class="no-matches"><div class="no-matches-icon">‚ùå</div>Error connecting to server</div>`;
        document.getElementById('liveMatchesList').innerHTML = errorMsg;
        document.getElementById('recentMatchesList').innerHTML = errorMsg;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  PLAYER PROFILE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // Track which screen we came from so back button works correctly
    let profileReturnScreen = 'scorecardScreen';

    function showPlayerProfile(playerName, returnScreen) {
        profileReturnScreen = returnScreen || 'scorecardScreen';

        // Hide all screens, show player screen
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        const playerScreen = document.getElementById('playerScreen');
        playerScreen.classList.add('active');

        // Show loading state immediately
        playerScreen.innerHTML = `
            <div class="profile-header">
                <span class="profile-back" onclick="closePlayerProfile()">‚Üê Back</span>
                <div class="profile-avatar">üèè</div>
                <div class="profile-name">${playerName}</div>
            </div>
            <div class="profile-loading">Loading match history‚Ä¶</div>
        `;

        // Fetch all matches from Firebase and mine this player's data
        database.ref('matches').once('value').then(snapshot => {
            const allMatches = snapshot.val() || {};
            renderPlayerProfile(playerName, allMatches);
        }).catch(() => {
            playerScreen.innerHTML += `<div class="profile-empty">Could not load match data.</div>`;
        });
    }

    function closePlayerProfile() {
        document.getElementById('playerScreen').classList.remove('active');
        document.getElementById(profileReturnScreen).classList.add('active');
    }

    function renderPlayerProfile(playerName, allMatches) {
        // ‚îÄ‚îÄ Mine all appearances across all matches ‚îÄ‚îÄ
        const battingHistory = [];   // { matchId, match, innings, stats }
        const bowlingHistory = [];

        Object.keys(allMatches).forEach(matchId => {
            const m = allMatches[matchId];
            if (!m) return;
            const matchLabel = `${m.teamA.name} vs ${m.teamB.name}`;
            const matchDate = m.lastUpdated ? new Date(m.lastUpdated).toLocaleDateString('en-IN', { day:'numeric', month:'short', year:'numeric' }) : '';

            // Helper: check a player array for this player's stats
            function extractBatting(players, inningsLabel) {
                if (!players) return;
                const p = players.find(pl => pl.name === playerName);
                if (p && (p.balls > 0 || p.isOut)) {
                    battingHistory.push({ matchId, matchLabel, matchDate, inningsLabel, stats: p });
                }
            }
            function extractBowling(players, inningsLabel) {
                if (!players) return;
                const p = players.find(pl => pl.name === playerName);
                if (p && p.bowlingBalls > 0) {
                    bowlingHistory.push({ matchId, matchLabel, matchDate, inningsLabel, stats: p });
                }
            }

            // 1st innings stored arrays
            extractBatting(m.firstInningsBatting, '1st Innings');
            extractBowling(m.firstInningsBowling, '1st Innings');

            // 2nd innings: battingTeam.players / bowlingTeam.players (live or completed)
            extractBatting(m.battingTeam && m.battingTeam.players, '2nd Innings');
            extractBowling(m.bowlingTeam && m.bowlingTeam.players, '2nd Innings');

            // Fallback fields used by some completed match structures
            extractBatting(m.secondInningsBatting, '2nd Innings');
            extractBowling(m.secondInningsBowling, '2nd Innings');
        });

        // Deduplicate: same matchId + inningsLabel may appear from multiple sources
        function dedupe(arr) {
            const seen = new Set();
            return arr.filter(item => {
                const key = item.matchId + '|' + item.inningsLabel;
                if (seen.has(key)) return false;
                seen.add(key); return true;
            });
        }
        const batRows = dedupe(battingHistory).sort((a,b) => b.matchId.localeCompare(a.matchId));
        const bowlRows = dedupe(bowlingHistory).sort((a,b) => b.matchId.localeCompare(a.matchId));

        // ‚îÄ‚îÄ Career aggregates ‚îÄ‚îÄ
        const bat = batRows.reduce((acc, r) => {
            const s = r.stats;
            acc.matches++;
            acc.runs += (s.runs || 0);
            acc.balls += (s.balls || 0);
            acc.fours += (s.fours || 0);
            acc.sixes += (s.sixes || 0);
            if (!s.isOut && !s.isRetired) acc.notOuts++;
            if ((s.runs || 0) > acc.highest) acc.highest = s.runs || 0;
            return acc;
        }, { matches:0, runs:0, balls:0, fours:0, sixes:0, notOuts:0, highest:0 });

        const bowl = bowlRows.reduce((acc, r) => {
            const s = r.stats;
            acc.matches++;
            acc.balls += (s.bowlingBalls || 0);
            acc.runs += (s.bowlingRuns || 0);
            acc.wickets += (s.bowlingWickets || 0);
            if ((s.bowlingWickets || 0) > acc.bestWickets ||
                ((s.bowlingWickets || 0) === acc.bestWickets && (s.bowlingRuns||0) < acc.bestRuns)) {
                acc.bestWickets = s.bowlingWickets || 0;
                acc.bestRuns = s.bowlingRuns || 0;
            }
            return acc;
        }, { matches:0, balls:0, runs:0, wickets:0, bestWickets:0, bestRuns:999 });

        const batAvg = bat.matches > 0 && (bat.matches - bat.notOuts) > 0
            ? (bat.runs / (bat.matches - bat.notOuts)).toFixed(1)
            : bat.runs > 0 ? '‚àû' : '‚Äî';
        const batSR = bat.balls > 0 ? ((bat.runs / bat.balls) * 100).toFixed(1) : '‚Äî';
        const bowlOvers = `${Math.floor(bowl.balls/6)}.${bowl.balls%6}`;
        const bowlAvg = bowl.wickets > 0 ? (bowl.runs / bowl.wickets).toFixed(1) : '‚Äî';
        const bowlEcon = bowl.balls > 0 ? (bowl.runs / (bowl.balls/6)).toFixed(2) : '‚Äî';
        const bestFigures = bowl.matches > 0 ? `${bowl.bestWickets}/${bowl.bestRuns === 999 ? 0 : bowl.bestRuns}` : '‚Äî';

        // ‚îÄ‚îÄ Build HTML ‚îÄ‚îÄ
        const playerScreen = document.getElementById('playerScreen');
        let html = `
            <div class="profile-header">
                <span class="profile-back" onclick="closePlayerProfile()">‚Üê Back</span>
                <div class="profile-avatar">üèè</div>
                <div class="profile-name">${playerName}</div>
            </div>
            <div class="profile-body">
        `;

        // Career summary grid
        if (bat.matches > 0 || bowl.matches > 0) {
            html += `<div style="font-size:13px;font-weight:bold;color:#ff6b35;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px;">üèÜ Career Summary</div>`;
            html += `<div class="career-grid">`;
            if (bat.matches > 0) {
                html += `
                    <div class="career-card"><div class="career-card-label">Total Runs</div><div class="career-card-value">${bat.runs}</div><div class="career-card-sub">${bat.matches} inning${bat.matches!==1?'s':''}</div></div>
                    <div class="career-card"><div class="career-card-label">Highest</div><div class="career-card-value">${bat.highest}</div><div class="career-card-sub">Best score</div></div>
                    <div class="career-card"><div class="career-card-label">Avg</div><div class="career-card-value">${batAvg}</div><div class="career-card-sub">Batting avg</div></div>
                    <div class="career-card"><div class="career-card-label">Strike Rate</div><div class="career-card-value">${batSR}</div><div class="career-card-sub">${bat.fours}√ó4  ${bat.sixes}√ó6</div></div>
                `;
            }
            if (bowl.matches > 0) {
                html += `
                    <div class="career-card"><div class="career-card-label">Wickets</div><div class="career-card-value" style="color:#dc3545;">${bowl.wickets}</div><div class="career-card-sub">${bowl.matches} spell${bowl.matches!==1?'s':''}</div></div>
                    <div class="career-card"><div class="career-card-label">Best</div><div class="career-card-value" style="color:#dc3545;">${bestFigures}</div><div class="career-card-sub">Best figures</div></div>
                    <div class="career-card"><div class="career-card-label">Economy</div><div class="career-card-value" style="color:#dc3545;">${bowlEcon}</div><div class="career-card-sub">${bowlOvers} overs</div></div>
                    <div class="career-card"><div class="career-card-label">Bowl Avg</div><div class="career-card-value" style="color:#dc3545;">${bowlAvg}</div><div class="career-card-sub">Avg per wicket</div></div>
                `;
            }
            html += `</div>`;
        }

        // Tabs
        const showBowl = bowl.matches > 0;
        const showBat = bat.matches > 0;

        if (showBat || showBowl) {
            html += `
                <div class="profile-tabs">
                    ${showBat ? `<button class="profile-tab active" id="tab-bat" onclick="switchProfileTab('bat')">üèè Batting (${batRows.length})</button>` : ''}
                    ${showBowl ? `<button class="profile-tab ${!showBat ? 'active' : ''}" id="tab-bowl" onclick="switchProfileTab('bowl')">‚öæ Bowling (${bowlRows.length})</button>` : ''}
                </div>
            `;

            // Batting history tab
            if (showBat) {
                html += `<div class="profile-tab-content active" id="tabcontent-bat">`;
                batRows.forEach(row => {
                    const s = row.stats;
                    const sr = s.balls > 0 ? ((s.runs/s.balls)*100).toFixed(0) : 0;
                    const dismissalText = s.isOut ? (s.dismissal || 'OUT') : s.isRetired ? (s.retiredType || 'Retired') : 'Not Out';
                    const isNotOut = !s.isOut && !s.isRetired;
                    html += `
                        <div class="match-history-row">
                            <div class="match-history-meta">
                                <div class="match-history-teams">${row.matchLabel}</div>
                                <div class="match-history-date">${row.matchDate}</div>
                            </div>
                            <div style="font-size:11px;color:#aaa;margin-bottom:8px;">${row.inningsLabel}</div>
                            <div class="match-history-stats">
                                <span class="stat-pill highlight">${s.runs}${isNotOut ? '*' : ''} (${s.balls}b)</span>
                                <span class="stat-pill">SR ${sr}</span>
                                ${s.fours > 0 ? `<span class="stat-pill">${s.fours}√ó4Ô∏è‚É£</span>` : ''}
                                ${s.sixes > 0 ? `<span class="stat-pill">${s.sixes}√ó6Ô∏è‚É£</span>` : ''}
                                <span class="stat-pill" style="${s.isOut?'color:#dc3545;':isNotOut?'color:#28a745;':''}">${dismissalText}</span>
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Bowling history tab
            if (showBowl) {
                html += `<div class="profile-tab-content ${!showBat ? 'active' : ''}" id="tabcontent-bowl">`;
                bowlRows.forEach(row => {
                    const s = row.stats;
                    const overs = `${Math.floor(s.bowlingBalls/6)}.${s.bowlingBalls%6}`;
                    const econ = s.bowlingBalls > 0 ? (s.bowlingRuns/(s.bowlingBalls/6)).toFixed(1) : '0.0';
                    html += `
                        <div class="match-history-row">
                            <div class="match-history-meta">
                                <div class="match-history-teams">${row.matchLabel}</div>
                                <div class="match-history-date">${row.matchDate}</div>
                            </div>
                            <div style="font-size:11px;color:#aaa;margin-bottom:8px;">${row.inningsLabel}</div>
                            <div class="match-history-stats">
                                <span class="stat-pill wicket">${s.bowlingWickets}/${s.bowlingRuns}</span>
                                <span class="stat-pill">${overs} overs</span>
                                <span class="stat-pill">Econ ${econ}</span>
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            }

        } else {
            html += `<div class="profile-empty"><div style="font-size:48px;margin-bottom:12px;">üèè</div>No match data found for ${playerName}</div>`;
        }

        html += `</div>`; // close profile-body
        playerScreen.innerHTML = html;
    }

    function switchProfileTab(tab) {
        document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.profile-tab-content').forEach(t => t.classList.remove('active'));
        const tabEl = document.getElementById('tab-' + tab);
        const contentEl = document.getElementById('tabcontent-' + tab);
        if (tabEl) tabEl.classList.add('active');
        if (contentEl) contentEl.classList.add('active');
    }

    window.addEventListener('beforeunload', () => {
        if (database && liveMatchesListener) {
            database.ref('matches').off('value', liveMatchesListener);
        }
        stopScorecardListener();
    });

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        });
    }

    window.onload = init;
</script>
```

</body>
</html>
