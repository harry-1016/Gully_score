<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ff6b35">
    <meta name="description" content="Cricket scoring admin panel">
    <link rel="manifest" href="manifest-admin.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>GULLY SCORE Admin</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); min-height: 100vh; }
        .container { max-width: 600px; margin: 0 auto; background: white; min-height: 100vh; box-shadow: 0 0 50px rgba(0,0,0,0.3); }
        .app-header { background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .app-name { font-family: 'Bangers', cursive; font-size: 40px; color: white; text-shadow: 3px 3px 6px rgba(0,0,0,0.4); letter-spacing: 2px; margin-bottom: 5px; }
        .app-tagline { color: white; font-size: 12px; opacity: 0.9; font-weight: 300; }
        .admin-badge { background: #dc3545; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-top: 8px; display: inline-block; }
        .screen { display: none; padding: 20px; min-height: calc(100vh - 100px); }
        .screen.active { display: block; }
        .hero-icon { width: 150px; height: 150px; margin: 30px auto; background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 70px; box-shadow: 0 10px 40px rgba(255,107,53,0.4); }
        .start-match-btn { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 20px 60px; border-radius: 50px; font-size: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 5px 25px rgba(40,167,69,0.4); transition: all 0.3s; margin-bottom: 20px; }
        .start-match-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 30px rgba(40,167,69,0.5); }
        .form-section { background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .section-header { display: flex; align-items: center; gap: 10px; font-size: 18px; font-weight: bold; color: #ff6b35; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-weight: 600; margin-bottom: 6px; color: #333; font-size: 14px; }
        .form-input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: all 0.3s; }
        .form-input:focus { outline: none; border-color: #ff6b35; box-shadow: 0 0 0 3px rgba(255,107,53,0.1); }
        .team-name-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .expand-btn { background: #ff6b35; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; white-space: nowrap; }
        .players-container { display: none; margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0; }
        .players-container.show { display: block; }
        .player-input-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        .player-number { background: #ff6b35; color: white; width: 35px; height: 35px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; flex-shrink: 0; }
        .player-input { flex: 1; padding: 8px 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 13px; }
        .btn { padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s; margin: 5px; }
        .btn-primary { background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255,107,53,0.4); }
        .btn-secondary { background: #6c757d; color: white; }
        .toss-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .toss-card { background: white; border: 3px solid #e0e0e0; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .toss-card:hover { border-color: #ff6b35; transform: scale(1.05); }
        .toss-card.selected { border-color: #ff6b35; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); }
        .toss-card-icon { font-size: 40px; margin-bottom: 10px; }
        .toss-card-text { font-weight: bold; color: #333; }
        .decision-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .decision-card { background: white; border: 3px solid #e0e0e0; border-radius: 12px; padding: 25px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .decision-card:hover { border-color: #ff6b35; transform: scale(1.05); }
        .decision-card.selected { border-color: #28a745; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); }
        .decision-card-icon { font-size: 50px; margin-bottom: 10px; }
        .decision-card-text { font-weight: bold; color: #333; font-size: 16px; }
        .score-display { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 3px 15px rgba(0,0,0,0.1); }
        .score-header { text-align: center; margin-bottom: 15px; }
        .vs-teams { font-size: 16px; color: #666; font-weight: 600; }
        .innings-badge { display: inline-block; background: #ff6b35; color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-top: 8px; }
        .main-score { text-align: center; margin: 15px 0; }
        .score-number { font-size: 48px; font-weight: bold; color: #ff6b35; }
        .overs-info { font-size: 14px; color: #666; margin-top: 5px; }
        .batsmen-info { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .batsman-card { background: white; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; }
        .batsman-name { font-weight: bold; color: #333; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
        .strike-indicator { width: 8px; height: 8px; background: #28a745; border-radius: 50%; display: inline-block; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .batsman-stats { font-size: 14px; color: #666; }
        .bowler-info { background: white; padding: 12px; border-radius: 8px; text-align: center; border: 2px solid #e0e0e0; margin-bottom: 15px; }
        .bowler-label { font-size: 12px; color: #666; margin-bottom: 5px; }
        .bowler-name { font-weight: bold; color: #333; margin-bottom: 5px; }
        .bowler-stats { font-size: 14px; color: #666; }
        .current-over { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .over-title { font-size: 14px; font-weight: bold; color: #333; margin-bottom: 10px; text-align: center; }
        .balls-container { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
        .ball-dot { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; background: #e0e0e0; color: #333; }
        .ball-dot.dot { background: #6c757d; color: white; }
        .ball-dot.one, .ball-dot.two, .ball-dot.three { background: #28a745; color: white; }
        .ball-dot.four { background: #007bff; color: white; }
        .ball-dot.six { background: #9c27b0; color: white; }
        .ball-dot.wicket { background: #dc3545; color: white; }
        .ball-dot.wide, .ball-dot.noball { background: #ffc107; color: #333; }
        .scoring-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px; }
        .score-btn { padding: 18px 8px; border: 2px solid #e0e0e0; border-radius: 12px; background: white; font-size: 22px; font-weight: bold; cursor: pointer; transition: all 0.2s; touch-action: manipulation; }
        .score-btn:hover { background: #f8f9fa; transform: scale(1.05); }
        .score-btn:active { transform: scale(0.92); }
        .score-btn.dot { color: #6c757d; border-color: #6c757d; }
        .score-btn.runs { color: #28a745; border-color: #28a745; }
        .score-btn.four { color: #007bff; border-color: #007bff; background: #e8f4ff; }
        .score-btn.six { color: #9c27b0; border-color: #9c27b0; background: #f3e5f5; }
        .score-btn.wicket { color: #dc3545; border-color: #dc3545; background: #fff5f5; }
        .score-btn.extra { color: #e65100; border-color: #ffc107; background: #fff8e1; }
        .extras-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px; }
        .extra-btn { padding: 12px 6px; border: 2px solid #ffc107; border-radius: 10px; background: #fff8e1; font-size: 13px; font-weight: bold; color: #e65100; cursor: pointer; transition: all 0.2s; touch-action: manipulation; }
        .extra-btn:active { transform: scale(0.92); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { font-size: 22px; font-weight: bold; color: #ff6b35; margin-bottom: 20px; text-align: center; }
        .player-selection { display: grid; gap: 10px; margin-bottom: 20px; }
        .player-card-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
        .player-card-row { display: flex; align-items: center; gap: 8px; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 10px; background: white; transition: border-color 0.2s; cursor: pointer; }
        .player-card-row:hover { border-color: #ff6b35; }
        .player-card-row.selected { border-color: #ff6b35; background: #fff8f5; }
        .player-card-row.disabled { opacity: 0.42; pointer-events: none; }
        .player-card-info { flex: 1; }
        .player-card-name { font-weight: 600; font-size: 15px; color: #222; }
        .player-card-meta { font-size: 12px; color: #999; margin-top: 1px; }
        .player-card-edit-btn { background: none; border: 1px solid #ccc; border-radius: 6px; padding: 4px 10px; font-size: 12px; color: #666; cursor: pointer; flex-shrink: 0; }
        .player-card-edit-btn:hover { border-color: #ff6b35; color: #ff6b35; }
        .player-card-edit-input { flex: 1; padding: 6px 10px; border: 2px solid #ff6b35; border-radius: 6px; font-size: 14px; outline: none; }
        .player-card-save-btn { background: #28a745; color: white; border: none; border-radius: 6px; padding: 6px 12px; font-size: 13px; cursor: pointer; flex-shrink: 0; }

```
    /* ‚îÄ‚îÄ Player photo avatar on card ‚îÄ‚îÄ */
    .player-card-avatar {
        width: 44px; height: 44px; border-radius: 50%;
        background: linear-gradient(135deg, #ff6b35, #f7931e);
        display: flex; align-items: center; justify-content: center;
        font-size: 15px; font-weight: bold; color: white;
        flex-shrink: 0; overflow: hidden;
        border: 2px solid rgba(255,107,53,0.3);
        cursor: pointer; position: relative;
        box-shadow: 0 2px 8px rgba(255,107,53,0.25);
        transition: transform 0.15s, box-shadow 0.15s;
    }
    .player-card-avatar:active { transform: scale(0.93); }
    .player-card-avatar img {
        width: 100%; height: 100%; object-fit: cover; border-radius: 50%;
    }
    .avatar-cam-overlay {
        position: absolute; inset: 0; border-radius: 50%;
        background: rgba(0,0,0,0.38);
        display: none; align-items: center; justify-content: center;
        font-size: 15px;
    }
    .player-card-avatar:hover .avatar-cam-overlay { display: flex; }

    /* ‚îÄ‚îÄ Photo picker bottom sheet ‚îÄ‚îÄ */
    .photo-picker-sheet {
        display: none; position: fixed; inset: 0; z-index: 9999;
        background: rgba(0,0,0,0.55);
        align-items: flex-end; justify-content: center;
    }
    .photo-picker-sheet.active { display: flex; }
    .photo-picker-inner {
        background: white; border-radius: 20px 20px 0 0;
        padding: 22px 20px 36px; width: 100%; max-width: 520px;
    }
    .photo-picker-title {
        font-size: 13px; font-weight: bold; color: #999;
        text-align: center; text-transform: uppercase;
        letter-spacing: 0.5px; margin-bottom: 18px;
    }
    .photo-picker-player {
        font-size: 17px; font-weight: bold; color: #333;
        text-align: center; margin-bottom: 20px;
    }
    .photo-picker-btn {
        width: 100%; padding: 16px; border: 2px solid #e0e0e0;
        border-radius: 12px; background: white;
        font-size: 16px; font-weight: bold; color: #333;
        cursor: pointer; margin-bottom: 10px;
        display: flex; align-items: center; gap: 14px;
        transition: all 0.2s;
    }
    .photo-picker-btn:hover { border-color: #ff6b35; background: #fff5f0; }
    .photo-picker-btn .btn-icon {
        width: 44px; height: 44px; border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        font-size: 22px; flex-shrink: 0;
    }
    .photo-picker-btn.camera .btn-icon { background: #e3f2fd; }
    .photo-picker-btn.gallery .btn-icon { background: #f3e5f5; }
    .photo-picker-cancel {
        width: 100%; padding: 14px; border: none; border-radius: 12px;
        background: #f5f5f5; font-size: 15px; font-weight: bold;
        color: #666; cursor: pointer; margin-top: 6px;
    }
    .photo-picker-cancel:hover { background: #eee; }
    .photo-upload-progress {
        font-size: 11px; color: #ff6b35; text-align: center;
        font-weight: bold; margin-top: 3px; min-height: 16px;
    }
    .dismissal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
    .dismissal-btn { padding: 14px 8px; border: 2px solid #e0e0e0; border-radius: 10px; background: white; font-size: 14px; font-weight: bold; cursor: pointer; text-align: center; transition: all 0.2s; }
    .dismissal-btn:hover { border-color: #ff6b35; background: #fff5f0; }
    .dismissal-btn.caught  { border-color: #007bff; color: #007bff; background: #e8f4ff; }
    .dismissal-btn.bowled  { border-color: #dc3545; color: #dc3545; background: #fff5f5; }
    .dismissal-btn.lbw     { border-color: #6f42c1; color: #6f42c1; background: #f5f0ff; }
    .dismissal-btn.stumped { border-color: #fd7e14; color: #fd7e14; background: #fff3e8; }
    .dismissal-btn.runout  { border-color: #e83e8c; color: #e83e8c; background: #fff0f5; }
    .dismissal-btn.other   { border-color: #6c757d; color: #6c757d; }
    .dismissal-btn.retired { border-color: #ff9800; color: #ff9800; background: #fff8e1; }
    .fielder-list { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
    .fielder-btn { padding: 11px 8px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; font-size: 13px; font-weight: 600; cursor: pointer; text-align: center; transition: all 0.2s; }
    .fielder-btn:hover { border-color: #28a745; background: #f0fff4; color: #28a745; }
    .modal-step-title { font-size: 12px; font-weight: bold; color: #ff6b35; text-transform: uppercase; letter-spacing: 0.5px; text-align: center; margin-bottom: 12px; }
    .modal-back-btn { width: 100%; padding: 10px; background: #f0f0f0; border: none; border-radius: 8px; color: #666; font-size: 13px; font-weight: bold; cursor: pointer; margin-top: 4px; }
    .modal-back-btn:hover { background: #e0e0e0; }
    .target-info { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; display: none; }
    .target-info.show { display: block; }
    .target-runs { font-size: 20px; font-weight: bold; color: #1976d2; margin-bottom: 5px; }
    .target-balls { font-size: 14px; color: #666; }
    .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
    .action-btn { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
    .undo-btn { background: #ffc107; color: #333; }
    .end-innings-btn { background: #dc3545; color: white; }
    .scorecard-btn { background: #007bff; color: white; }
    .end-match-btn { background: #28a745; color: white; }
    .scorecard-panel { margin-top: 12px; border: 2px solid #ff6b35; border-radius: 12px; overflow: hidden; }
    .scorecard-toggle { background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); color: white; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: bold; font-size: 14px; user-select: none; }
    .scorecard-toggle-arrow { transition: transform 0.3s; }
    .scorecard-panel.open .scorecard-toggle-arrow { transform: rotate(180deg); }
    .scorecard-inner { display: none; background: white; padding: 12px; }
    .scorecard-panel.open .scorecard-inner { display: block; }
    .sc-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 12px; }
    .sc-table th { background: #f8f9fa; padding: 6px 4px; text-align: left; color: #666; font-size: 11px; font-weight: 600; border-bottom: 1px solid #e0e0e0; }
    .sc-table td { padding: 6px 4px; border-bottom: 1px solid #f5f5f5; }
    .sc-table tr:last-child td { border-bottom: none; }
    .sc-table .sc-active { background: #fff3e0; }
    .sc-badge { display: inline-block; padding: 1px 6px; border-radius: 8px; font-size: 9px; font-weight: bold; margin-left: 4px; vertical-align: middle; }
    .sc-badge.out { background: #dc3545; color: white; }
    .sc-badge.retired { background: #ff9800; color: white; }
    .sc-badge.batting { background: #28a745; color: white; }
    .sc-section-label { font-size: 11px; font-weight: bold; color: #ff6b35; margin: 8px 0 4px; text-transform: uppercase; letter-spacing: 0.5px; }
</style>
```

</head>
<body>
    <div class="container">
        <div id="loginScreen" class="screen active">
            <div class="app-header">
                <div class="app-name">GULLY SCORE</div>
                <div class="app-tagline">made with ‚ù§Ô∏è harry goud</div>
                <div class="admin-badge">ADMIN PANEL</div>
            </div>
            <div style="padding: 40px 20px; text-align: center;">
                <div style="font-size: 80px; margin-bottom: 30px;">üîê</div>
                <h2 style="font-size: 24px; color: #333; margin-bottom: 30px;">Admin Login</h2>
                <div class="form-section" style="max-width: 400px; margin: 0 auto;">
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="adminPassword" class="form-input" placeholder="Enter admin password" onkeypress="if(event.key==='Enter') checkPassword()">
                    </div>
                    <div id="loginError" style="color: #dc3545; margin: 10px 0; font-size: 14px; display: none;"></div>
                    <button class="btn btn-primary" onclick="checkPassword()" style="width: 100%; margin-top: 20px;">Login</button>
                    <div style="margin-top: 20px; font-size: 12px; color: #999;">Default password: <strong>admin123</strong></div>
                </div>
            </div>
        </div>

```
    <div class="app-header" id="mainHeader" style="display: none;">
        <div class="app-name">GULLY SCORE</div>
        <div class="app-tagline">made with ‚ù§Ô∏è harry goud</div>
        <div class="admin-badge">ADMIN PANEL</div>
    </div>

    <div id="homeScreen" class="screen">
        <div class="hero-icon">üèè</div>
        <div style="text-align: center;">
            <button class="start-match-btn" onclick="showSetup()">Start New Match</button>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="showSavedTeams()" style="padding: 12px 24px; font-size: 16px;">üìã Saved Teams</button>
                <button class="btn btn-secondary" onclick="showMatchHistory()" style="padding: 12px 24px; font-size: 16px;">üìä Match History</button>
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="logout()" style="padding: 10px 20px; font-size: 14px; background: #dc3545;">üö™ Logout</button>
            </div>
        </div>
    </div>

    <div id="setupScreen" class="screen">
        <div class="form-section">
            <div class="section-header"><span>‚öôÔ∏è</span><span>Match Settings</span></div>
            <div class="form-group">
                <label class="form-label">Number of Overs</label>
                <input type="number" id="oversInput" class="form-input" value="5" min="1">
                <div style="margin-top: 8px; font-size: 13px; color: #666;" id="currentTime"></div>
            </div>
        </div>
        <div class="form-section">
            <div class="section-header"><span>üèÜ</span><span>Team A</span></div>
            <div class="form-group" style="margin-bottom: 10px;">
                <label class="form-label">Load Saved Team (Optional)</label>
                <select id="teamALoadSelect" class="form-input" onchange="loadSavedTeam('A', this.value)">
                    <option value="">-- Select a saved team --</option>
                </select>
            </div>
            <div class="team-name-row">
                <input type="text" id="teamAName" class="form-input" placeholder="Team A Name" style="flex: 1;">
                <button class="expand-btn" onclick="togglePlayers('A')">Add Players</button>
            </div>
            <div id="teamAPlayers" class="players-container"><div id="teamAPlayersList"></div></div>
        </div>
        <div class="form-section">
            <div class="section-header"><span>üèÜ</span><span>Team B</span></div>
            <div class="form-group" style="margin-bottom: 10px;">
                <label class="form-label">Load Saved Team (Optional)</label>
                <select id="teamBLoadSelect" class="form-input" onchange="loadSavedTeam('B', this.value)">
                    <option value="">-- Select a saved team --</option>
                </select>
            </div>
            <div class="team-name-row">
                <input type="text" id="teamBName" class="form-input" placeholder="Team B Name" style="flex: 1;">
                <button class="expand-btn" onclick="togglePlayers('B')">Add Players</button>
            </div>
            <div id="teamBPlayers" class="players-container"><div id="teamBPlayersList"></div></div>
        </div>
        <div style="text-align: center; margin-top: 30px;">
            <button class="btn btn-secondary" onclick="showHome()">Back</button>
            <button class="btn btn-primary" onclick="proceedToToss()">Proceed to Toss</button>
        </div>
    </div>

    <div id="tossScreen" class="screen">
        <div class="form-section">
            <div class="section-header"><span>ü™ô</span><span>Toss</span></div>
            <p style="text-align: center; margin-bottom: 20px; color: #666;">Who won the toss?</p>
            <div class="toss-options">
                <div class="toss-card" onclick="selectTossWinner('A')">
                    <div class="toss-card-icon">üèÜ</div>
                    <div class="toss-card-text" id="tossTeamA">Team A</div>
                </div>
                <div class="toss-card" onclick="selectTossWinner('B')">
                    <div class="toss-card-icon">üèÜ</div>
                    <div class="toss-card-text" id="tossTeamB">Team B</div>
                </div>
            </div>
        </div>
        <div id="decisionSection" class="form-section" style="display: none;">
            <div class="section-header"><span>üéØ</span><span>Decision</span></div>
            <p style="text-align: center; margin-bottom: 20px; color: #666;">What do they choose?</p>
            <div class="decision-options">
                <div class="decision-card" onclick="selectDecision('bat')">
                    <div class="decision-card-icon">üèè</div>
                    <div class="decision-card-text">BAT</div>
                </div>
                <div class="decision-card" onclick="selectDecision('bowl')">
                    <div class="decision-card-icon">‚öæ</div>
                    <div class="decision-card-text">BOWL</div>
                </div>
            </div>
        </div>
        <div style="text-align: center; margin-top: 30px;">
            <button class="btn btn-secondary" onclick="showSetup()">Back</button>
            <button class="btn btn-primary" id="startMatchBtn" style="display: none;" onclick="startMatch()">Start Match</button>
        </div>
    </div>

    <div id="scoringScreen" class="screen">
        <div class="score-display">
            <div class="score-header">
                <div class="vs-teams" id="vsTeams"></div>
                <div class="innings-badge" id="inningsBadge"></div>
            </div>
            <div class="main-score">
                <div class="score-number" id="mainScore">0/0</div>
                <div class="overs-info" id="oversInfo">Overs: 0.0 / 5</div>
            </div>
            <div id="targetInfo" class="target-info">
                <div class="target-runs" id="targetRuns"></div>
                <div class="target-balls" id="targetBalls"></div>
            </div>
        </div>
        <div class="batsmen-info">
            <div class="batsman-card">
                <div class="batsman-name" id="striker1Name"><span class="strike-indicator" id="strike1"></span>Striker</div>
                <div class="batsman-stats" id="striker1Stats">0(0)</div>
            </div>
            <div class="batsman-card">
                <div class="batsman-name" id="striker2Name"><span class="strike-indicator" id="strike2" style="display:none;"></span>Non-Striker</div>
                <div class="batsman-stats" id="striker2Stats">0(0)</div>
            </div>
        </div>
        <div class="bowler-info">
            <div class="bowler-label">BOWLER</div>
            <div class="bowler-name" id="bowlerNameDisplay">-</div>
            <div class="bowler-stats" id="bowlerStatsDisplay">0-0 (0.0)</div>
        </div>
        <div class="current-over">
            <div class="over-title">Current Over</div>
            <div class="balls-container" id="currentOverBalls"><div class="ball-dot">-</div></div>
        </div>
        <div class="scoring-grid">
            <button class="score-btn dot" onclick="recordRun(0,'dot')">0</button>
            <button class="score-btn runs" onclick="recordRun(1)">1</button>
            <button class="score-btn runs" onclick="recordRun(2)">2</button>
            <button class="score-btn runs" onclick="recordRun(3)">3</button>
            <button class="score-btn four" onclick="recordRun(4)">4</button>
            <button class="score-btn six" onclick="recordRun(6)">6</button>
            <button class="score-btn wicket" onclick="showWicketModal()">W</button>
            <button class="score-btn extra" onclick="toggleExtras()">+EXT</button>
        </div>
        <div id="extrasSection" style="display:none;">
            <div class="extras-grid">
                <button class="extra-btn" onclick="recordExtra('wide')">Wide</button>
                <button class="extra-btn" onclick="recordExtra('noball')">No Ball</button>
                <button class="extra-btn" onclick="recordExtra('bye')">Bye</button>
                <button class="extra-btn" onclick="recordExtra('legbye')">Leg Bye</button>
            </div>
        </div>
        <div class="scorecard-panel" id="inlineScorecardPanel">
            <div class="scorecard-toggle" onclick="toggleInlineScorecard()">
                <span>üìä Live Scorecard</span>
                <span class="scorecard-toggle-arrow">‚ñº</span>
            </div>
            <div class="scorecard-inner" id="inlineScorecardContent"></div>
        </div>
        <div class="action-buttons">
            <button class="action-btn undo-btn" onclick="undoLastBall()">‚Ü∂ Undo</button>
            <button class="action-btn scorecard-btn" onclick="showScorecard()">üìä Scorecard</button>
            <button class="action-btn end-innings-btn" onclick="endInnings()">End Innings</button>
            <button class="action-btn end-match-btn" onclick="endMatch()">End Match</button>
        </div>
    </div>
</div>

<div id="wicketModal" class="modal"><div class="modal-content"><div class="player-selection" id="wicketPlayerSelection"></div></div></div>
<div id="newBatsmanModal" class="modal"><div class="modal-content"><div class="player-selection" id="newBatsmanSelection"></div></div></div>
<div id="newBowlerModal" class="modal"><div class="modal-content"><div class="player-selection" id="newBowlerSelection"></div></div></div>
<div id="scorecardModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Scorecard</div>
        <div id="scorecardContent"></div>
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn btn-primary" onclick="closeModal('scorecardModal')">Close</button>
        </div>
    </div>
</div>

<div id="savedTeamsScreen" class="screen">
    <div style="font-size: 20px; font-weight: bold; color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 3px solid #ff6b35; display: flex; align-items: center; gap: 10px;">
        <span>üìã</span><span>Saved Teams</span>
    </div>
    <div id="savedTeamsList"></div>
    <div style="text-align: center; margin-top: 30px;">
        <button class="btn btn-secondary" onclick="showHome()">Back to Home</button>
    </div>
</div>

<div id="matchHistoryScreen" class="screen">
    <div style="font-size: 20px; font-weight: bold; color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 3px solid #ff6b35; display: flex; align-items: center; gap: 10px;">
        <span>üìä</span><span>Match History</span>
    </div>
    <div id="matchHistoryList"></div>
    <div style="text-align: center; margin-top: 30px;">
        <button class="btn btn-secondary" onclick="showHome()">Back to Home</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCpV2GXvuCog7bTQoutpOoQovGvtYeqclw",
        authDomain: "gully-score.firebaseapp.com",
        databaseURL: "https://gully-score-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "gully-score",
        storageBucket: "gully-score.firebasestorage.app",
        messagingSenderId: "305069405268",
        appId: "1:305069405268:web:f368add1f10132bee829c1"
    };

    let database;
    let storage;
    let currentMatchId;
    const ADMIN_PASSWORD = 'Hari@1016';
    const SESSION_KEY = 'gullyScoreAdminSession';
    const ACTIVE_MATCH_KEY = 'gullyScoreActiveMatch';

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  FRESH STATE ‚Äî called on every new match / goHome
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function freshGameState() {
        return {
            teamA: { name: '', players: [] },
            teamB: { name: '', players: [] },
            overs: 5,
            battingTeam: null, bowlingTeam: null,
            striker: null, nonStriker: null, bowler: null,
            score: 0, wickets: 0,
            currentOver: 0, currentBall: 0,
            overBalls: [],
            innings: 1,
            matchStatus: 'live',
            firstInningsScore: 0, firstInningsWickets: 0, firstInningsOvers: 0,
            firstInningsBatting: [], firstInningsBowling: [],
            firstInningsBattingTeam: null
        };
    }

    let gameState = freshGameState();
    let undoStack = [];
    let tossWinner = null;
    let tossDecision = null;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  FIX: Full reset of all match-related state
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function resetGameState() {
        gameState  = freshGameState();
        currentMatchId = null;
        undoStack  = [];
        tossWinner = null;
        tossDecision = null;
        localStorage.removeItem(ACTIVE_MATCH_KEY);

        // Reset toss/decision UI selections
        document.querySelectorAll('.toss-card').forEach(c => c.classList.remove('selected'));
        document.querySelectorAll('.decision-card').forEach(c => c.classList.remove('selected'));
        const decisionSection = document.getElementById('decisionSection');
        if (decisionSection) decisionSection.style.display = 'none';
        const startMatchBtn = document.getElementById('startMatchBtn');
        if (startMatchBtn) startMatchBtn.style.display = 'none';

        // Reset setup form fields
        const teamAName = document.getElementById('teamAName');
        const teamBName = document.getElementById('teamBName');
        const oversInput = document.getElementById('oversInput');
        if (teamAName) teamAName.value = '';
        if (teamBName) teamBName.value = '';
        if (oversInput) oversInput.value = '5';

        // Regenerate empty player inputs
        generatePlayerInputs('A');
        generatePlayerInputs('B');

        // Collapse player panels
        document.getElementById('teamAPlayers').classList.remove('show');
        document.getElementById('teamBPlayers').classList.remove('show');

        // Reset saved-team dropdowns to blank
        const selA = document.getElementById('teamALoadSelect');
        const selB = document.getElementById('teamBLoadSelect');
        if (selA) selA.value = '';
        if (selB) selB.value = '';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  AUTH
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function checkPassword() {
        const password = document.getElementById('adminPassword').value;
        const errorDiv = document.getElementById('loginError');
        if (password === ADMIN_PASSWORD) {
            sessionStorage.setItem(SESSION_KEY, 'authenticated');
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('mainHeader').style.display = 'block';
            checkForActiveMatch();
            errorDiv.style.display = 'none';
        } else {
            errorDiv.textContent = 'Incorrect password. Please try again.';
            errorDiv.style.display = 'block';
            document.getElementById('adminPassword').value = '';
        }
    }

    function logout() {
        if (confirm('Are you sure you want to logout? Any unsaved progress will be lost.')) {
            sessionStorage.removeItem(SESSION_KEY);
            localStorage.removeItem(ACTIVE_MATCH_KEY);
            location.reload();
        }
    }

    function checkAuthentication() {
        if (sessionStorage.getItem(SESSION_KEY) === 'authenticated') {
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('mainHeader').style.display = 'block';
            checkForActiveMatch();
        } else {
            document.getElementById('loginScreen').classList.add('active');
            document.getElementById('mainHeader').style.display = 'none';
        }
    }

    function checkForActiveMatch() {
        const activeMatchId = localStorage.getItem(ACTIVE_MATCH_KEY);
        if (activeMatchId && database) {
            database.ref('matches/' + activeMatchId).once('value')
                .then(snapshot => {
                    const matchData = snapshot.val();
                    if (matchData && matchData.matchStatus === 'live') {
                        if (confirm('There is an active match in progress. Do you want to continue it?')) {
                            loadActiveMatch(matchData);
                        } else {
                            localStorage.removeItem(ACTIVE_MATCH_KEY);
                            showHome();
                        }
                    } else {
                        localStorage.removeItem(ACTIVE_MATCH_KEY);
                        showHome();
                    }
                })
                .catch(() => { localStorage.removeItem(ACTIVE_MATCH_KEY); showHome(); });
        } else {
            showHome();
        }
    }

    function loadActiveMatch(matchData) {
        gameState = matchData;
        currentMatchId = matchData.matchId;
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('scoringScreen').classList.add('active');
        updateScoringDisplay();
    }

    function saveActiveMatch() {
        if (currentMatchId && gameState.matchStatus === 'live') {
            localStorage.setItem(ACTIVE_MATCH_KEY, currentMatchId);
        } else {
            localStorage.removeItem(ACTIVE_MATCH_KEY);
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  INIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function init() {
        try {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            storage = firebase.storage();
        } catch (e) {
            alert('Firebase configuration error. Please check your Firebase config.');
        }
        generatePlayerInputs('A');
        generatePlayerInputs('B');
        updateCurrentTime();
        checkAuthentication();
        setInterval(updateCurrentTime, 60000);
    }

    function updateCurrentTime() {
        const opts = { weekday:'long', year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit' };
        document.getElementById('currentTime').textContent = 'üìÖ ' + new Date().toLocaleDateString('en-US', opts);
    }

    function generatePlayerInputs(team) {
        const container = document.getElementById(`team${team}PlayersList`);
        container.innerHTML = '';
        for (let i = 1; i <= 11; i++) {
            const row = document.createElement('div');
            row.className = 'player-input-row';
            row.innerHTML = `<div class="player-number">${i}</div><input type="text" class="player-input" placeholder="Player ${i} Name" id="team${team}Player${i}">`;
            container.appendChild(row);
        }
    }

    function togglePlayers(team) { document.getElementById(`team${team}Players`).classList.toggle('show'); }

    function showSetup() {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('setupScreen').classList.add('active');
        populateSavedTeamsDropdowns();
    }

    function proceedToToss() {
        document.getElementById('tossTeamA').textContent = document.getElementById('teamAName').value.trim() || 'Team A';
        document.getElementById('tossTeamB').textContent = document.getElementById('teamBName').value.trim() || 'Team B';
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('tossScreen').classList.add('active');
    }

    function selectTossWinner(team) {
        tossWinner = team;
        document.querySelectorAll('.toss-card').forEach(c => c.classList.remove('selected'));
        event.target.closest('.toss-card').classList.add('selected');
        document.getElementById('decisionSection').style.display = 'block';
    }

    function selectDecision(decision) {
        tossDecision = decision;
        document.querySelectorAll('.decision-card').forEach(c => c.classList.remove('selected'));
        event.target.closest('.decision-card').classList.add('selected');
        document.getElementById('startMatchBtn').style.display = 'inline-block';
    }

    function createPlayer(name) {
        return { name: name.trim() || 'Player', runs: 0, balls: 0, fours: 0, sixes: 0, isOut: false,
                 bowlingBalls: 0, bowlingRuns: 0, bowlingWickets: 0, bowlingMaidens: 0 };
    }

    function startMatch() {
        if (!tossWinner || !tossDecision) { alert('Please complete the toss'); return; }

        gameState.overs = parseInt(document.getElementById('oversInput').value) || 5;
        gameState.teamA.name = document.getElementById('teamAName').value.trim() || 'Team A';
        gameState.teamB.name = document.getElementById('teamBName').value.trim() || 'Team B';
        gameState.teamA.players = [];
        gameState.teamB.players = [];
        const teamAPlayerNames = [], teamBPlayerNames = [];

        for (let i = 1; i <= 11; i++) {
            const pA = document.getElementById(`teamAPlayer${i}`).value;
            const pB = document.getElementById(`teamBPlayer${i}`).value;
            if (pA.trim()) { gameState.teamA.players.push(createPlayer(pA)); teamAPlayerNames.push(pA.trim()); }
            if (pB.trim()) { gameState.teamB.players.push(createPlayer(pB)); teamBPlayerNames.push(pB.trim()); }
        }

        if (gameState.teamA.players.length < 2 || gameState.teamB.players.length < 2) {
            alert('Each team needs at least 2 players'); return;
        }

        saveTeamToFirebase(gameState.teamA.name, teamAPlayerNames);
        saveTeamToFirebase(gameState.teamB.name, teamBPlayerNames);

        const battingFirst = (tossWinner === 'A' && tossDecision === 'bat') ||
                             (tossWinner === 'B' && tossDecision === 'bowl') ? 'teamA' : 'teamB';

        gameState.battingTeam = battingFirst === 'teamA' ? gameState.teamA : gameState.teamB;
        gameState.bowlingTeam = battingFirst === 'teamA' ? gameState.teamB : gameState.teamA;
        gameState.firstInningsBattingTeam = battingFirst;
        currentMatchId = 'match_' + Date.now();
        selectOpeningBatsmen();
    }

    // ‚îÄ‚îÄ Player card list helper ‚îÄ‚îÄ
    function renderPlayerCardList(container, players, onSelect, disabledNames, selectedName) {
        if (!disabledNames) disabledNames = new Set();
        container.innerHTML = '';
        const list = document.createElement('div');
        list.className = 'player-card-list';

        players.forEach(function(player) {
            const isDisabled = disabledNames.has(player.name);
            const isSelected = selectedName === player.name;
            const row = document.createElement('div');
            row.className = 'player-card-row' + (isDisabled ? ' disabled' : '') + (isSelected ? ' selected' : '');

            // Avatar (photo or initials)
            const avatar = buildPlayerAvatar(player);
            row.appendChild(avatar);

            const info = document.createElement('div');
            info.className = 'player-card-info';
            info.style.flex = '1';
            const nameEl = document.createElement('div');
            nameEl.className = 'player-card-name';
            nameEl.textContent = player.name;
            info.appendChild(nameEl);

            if (player.balls > 0 || player.bowlingBalls > 0) {
                const meta = document.createElement('div');
                meta.className = 'player-card-meta';
                const parts = [];
                if (player.balls > 0) parts.push(player.runs + '(' + player.balls + ')');
                if (player.bowlingBalls > 0) {
                    parts.push(player.bowlingWickets + '-' + player.bowlingRuns +
                        ' (' + Math.floor(player.bowlingBalls/6) + '.' + (player.bowlingBalls%6) + ')');
                }
                meta.textContent = parts.join(' ¬∑ ');
                info.appendChild(meta);
            }

            if (!isDisabled) { info.style.cursor = 'pointer'; info.addEventListener('click', () => onSelect(player)); }
            row.appendChild(info);

            const editBtn = document.createElement('button');
            editBtn.className = 'player-card-edit-btn'; editBtn.textContent = '‚úèÔ∏è'; editBtn.type = 'button';
            editBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                info.innerHTML = '';
                const inp = document.createElement('input');
                inp.className = 'player-card-edit-input'; inp.value = player.name; inp.type = 'text';
                inp.addEventListener('click', ev => ev.stopPropagation());
                inp.addEventListener('keydown', ev => { if (ev.key === 'Enter') saveEdit(); });
                info.appendChild(inp);

                function saveEdit() {
                    const n = inp.value.trim(); if (n) player.name = n;
                    renderPlayerCardList(container, players, onSelect, disabledNames, selectedName);
                }
                const newBtn = editBtn.cloneNode(false);
                newBtn.textContent = '‚úì'; newBtn.className = 'player-card-save-btn'; newBtn.type = 'button';
                newBtn.addEventListener('click', e2 => { e2.stopPropagation(); saveEdit(); });
                editBtn.parentNode.replaceChild(newBtn, editBtn);
                inp.focus(); inp.select();
            });
            row.appendChild(editBtn);
            list.appendChild(row);
        });
        container.appendChild(list);
    }

    function selectOpeningBatsmen() {
        const modal = document.getElementById('newBatsmanModal');
        const selection = document.getElementById('newBatsmanSelection');
        let strikerPlayer = null;

        function showStrikerStep() {
            selection.innerHTML = '';
            const hdr = document.createElement('div'); hdr.className = 'modal-header'; hdr.textContent = 'Select Striker'; selection.appendChild(hdr);
            const sub = document.createElement('div'); sub.style.cssText = 'font-size:13px;color:#999;text-align:center;margin-bottom:14px;'; sub.textContent = 'Who faces first?'; selection.appendChild(sub);
            const lc = document.createElement('div');
            renderPlayerCardList(lc, gameState.battingTeam.players, p => { strikerPlayer = p; showNonStrikerStep(); }, new Set(), null);
            selection.appendChild(lc);
            const cancel = document.createElement('button'); cancel.className = 'modal-back-btn'; cancel.textContent = '‚úï Cancel'; cancel.onclick = () => modal.classList.remove('active'); selection.appendChild(cancel);
        }

        function showNonStrikerStep() {
            selection.innerHTML = '';
            const hdr = document.createElement('div'); hdr.className = 'modal-header'; hdr.textContent = 'Select Non-Striker'; selection.appendChild(hdr);
            const sub = document.createElement('div'); sub.style.cssText = 'font-size:13px;color:#999;text-align:center;margin-bottom:14px;'; sub.textContent = 'Striker: ' + strikerPlayer.name; selection.appendChild(sub);
            const lc = document.createElement('div');
            renderPlayerCardList(lc, gameState.battingTeam.players, p => {
                gameState.striker = strikerPlayer; gameState.nonStriker = p;
                modal.classList.remove('active'); selectOpeningBowler();
            }, new Set([strikerPlayer.name]), null);
            selection.appendChild(lc);
            const back = document.createElement('button'); back.className = 'modal-back-btn'; back.textContent = '‚Üê Back'; back.onclick = showStrikerStep; selection.appendChild(back);
        }

        showStrikerStep();
        modal.classList.add('active');
    }

    function selectOpeningBowler() {
        const modal = document.getElementById('newBowlerModal');
        const selection = document.getElementById('newBowlerSelection');
        selection.innerHTML = '';
        const hdr = document.createElement('div'); hdr.className = 'modal-header'; hdr.textContent = 'Select Opening Bowler'; selection.appendChild(hdr);
        const lc = document.createElement('div');
        renderPlayerCardList(lc, gameState.bowlingTeam.players, p => {
            gameState.bowler = p; modal.classList.remove('active'); startScoring();
        }, new Set(), null);
        selection.appendChild(lc);
        const cancel = document.createElement('button'); cancel.className = 'modal-back-btn'; cancel.textContent = '‚úï Cancel'; cancel.onclick = () => modal.classList.remove('active'); selection.appendChild(cancel);
        modal.classList.add('active');
    }

    function startScoring() {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('scoringScreen').classList.add('active');
        updateScoringDisplay();
        saveMatchToFirebase();
    }

    function takeSnapshot() { undoStack.push(JSON.stringify(gameState)); if (undoStack.length > 30) undoStack.shift(); }

    function recordRun(runs, ballType = 'normal') {
        if (gameState.matchStatus !== 'live') return;
        takeSnapshot();
        gameState.striker.runs += runs; gameState.striker.balls++; gameState.score += runs;
        if (runs === 4) gameState.striker.fours++;
        if (runs === 6) gameState.striker.sixes++;
        gameState.bowler.bowlingBalls++; gameState.bowler.bowlingRuns += runs;

        let ballClass = '', ballValue = runs;
        if (ballType === 'dot') { ballClass = 'dot'; ballValue = '‚Ä¢'; }
        else if (runs === 4) ballClass = 'four';
        else if (runs === 6) ballClass = 'six';
        else if (runs > 0) ballClass = 'one';
        gameState.overBalls.push({ value: ballValue, class: ballClass });
        if (runs % 2 === 1) swapStrike();

        if (gameState.innings === 2 && gameState.score >= gameState.firstInningsScore + 1) {
            advanceBall(); updateScoringDisplay(); saveMatchToFirebase();
            setTimeout(() => showMatchCompleted(), 500); return;
        }
        advanceBall(); updateScoringDisplay(); saveMatchToFirebase();
    }

    function recordExtra(type) {
        if (gameState.matchStatus !== 'live') return;
        takeSnapshot();
        gameState.score += 1; gameState.bowler.bowlingRuns += 1;
        const ballValue = type === 'wide' ? 'WD' : type === 'noball' ? 'NB' : type === 'bye' ? 'B' : 'LB';
        gameState.overBalls.push({ value: ballValue, class: type });
        if (type !== 'wide' && type !== 'noball') {
            gameState.striker.balls++; gameState.bowler.bowlingBalls++; advanceBall();
        }
        updateScoringDisplay(); saveMatchToFirebase();
    }

    function showWicketModal() { if (gameState.matchStatus !== 'live') return; wicketStep_WhoIsOut(); }

    function wicketStep_WhoIsOut() {
        const modal = document.getElementById('wicketModal');
        const sel = document.getElementById('wicketPlayerSelection');
        sel.innerHTML = '';
        const title = document.createElement('div'); title.className = 'modal-step-title'; title.textContent = 'Step 1 of 2 ‚Äî Who is out?'; sel.appendChild(title);
        const grid = document.createElement('div'); grid.className = 'fielder-list';
        [gameState.striker, gameState.nonStriker].forEach(player => {
            const btn = document.createElement('button');
            btn.className = 'fielder-btn'; btn.style.cssText = 'font-size:15px;padding:18px 8px;border-color:#dc3545;color:#dc3545;';
            btn.innerHTML = `<div style="font-size:11px;color:#999;margin-bottom:4px;">${player === gameState.striker ? 'üèè STRIKER' : 'üèè NON-STRIKER'}</div><strong>${player.name}</strong>`;
            btn.onclick = () => wicketStep_HowOut(player);
            grid.appendChild(btn);
        });
        sel.appendChild(grid);
        modal.classList.add('active');
    }

    function wicketStep_HowOut(outPlayer) {
        const sel = document.getElementById('wicketPlayerSelection');
        sel.innerHTML = '';
        const title = document.createElement('div'); title.className = 'modal-step-title'; title.textContent = `How was ${outPlayer.name} out?`; sel.appendChild(title);
        const grid = document.createElement('div'); grid.className = 'dismissal-grid';
        const types = [
            { label: 'üôå Caught', key: 'Caught', cls: 'caught' }, { label: 'üéØ Bowled', key: 'Bowled', cls: 'bowled' },
            { label: 'ü¶µ LBW', key: 'LBW', cls: 'lbw' }, { label: 'üß§ Stumped', key: 'Stumped', cls: 'stumped' },
            { label: 'üèÉ Run Out', key: 'Run Out', cls: 'runout' }, { label: '‚ùì Other', key: 'Other', cls: 'other' },
            { label: 'ü§ï Retired Hurt', key: 'Retired Hurt', cls: 'retired' }, { label: 'üö∂ Retired Out', key: 'Retired Out', cls: 'retired' }
        ];
        types.forEach(({ label, key, cls }) => {
            const btn = document.createElement('button');
            btn.className = `dismissal-btn ${cls}`; btn.textContent = label;
            btn.onclick = () => {
                if (key === 'Retired Hurt' || key === 'Retired Out') { document.getElementById('wicketModal').classList.remove('active'); handleRetired(outPlayer, key); }
                else if (key === 'Caught') wicketStep_Fielder(outPlayer, key, 'Who took the catch?', gameState.bowlingTeam.players);
                else if (key === 'Run Out') wicketStep_RunOutWho(outPlayer);
                else if (key === 'Stumped') wicketStep_Fielder(outPlayer, key, 'Who stumped? (keeper)', gameState.bowlingTeam.players);
                else { document.getElementById('wicketModal').classList.remove('active'); recordWicket(outPlayer, key, null, null); }
            };
            grid.appendChild(btn);
        });
        sel.appendChild(grid);
        const back = document.createElement('button'); back.className = 'modal-back-btn'; back.textContent = '‚Üê Back'; back.onclick = () => wicketStep_WhoIsOut(); sel.appendChild(back);
    }

    function wicketStep_RunOutWho(originalOutPlayer) {
        const sel = document.getElementById('wicketPlayerSelection');
        sel.innerHTML = '';
        const title = document.createElement('div'); title.className = 'modal-step-title'; title.textContent = 'Run Out ‚Äî Who was run out?'; sel.appendChild(title);
        const grid = document.createElement('div'); grid.className = 'fielder-list';
        [gameState.striker, gameState.nonStriker].forEach(player => {
            const btn = document.createElement('button'); btn.className = 'fielder-btn'; btn.style.cssText = 'padding:16px 8px;';
            btn.innerHTML = `<div style="font-size:11px;color:#999;margin-bottom:4px;">${player === gameState.striker ? 'STRIKER' : 'NON-STRIKER'}</div><strong>${player.name}</strong>`;
            btn.onclick = () => wicketStep_RunOutFielder(player);
            grid.appendChild(btn);
        });
        sel.appendChild(grid);
        const back = document.createElement('button'); back.className = 'modal-back-btn'; back.textContent = '‚Üê Back'; back.onclick = () => wicketStep_HowOut(originalOutPlayer); sel.appendChild(back);
    }

    function wicketStep_RunOutFielder(outPlayer) {
        const sel = document.getElementById('wicketPlayerSelection');
        sel.innerHTML = '';
        const title = document.createElement('div'); title.className = 'modal-step-title'; title.textContent = 'Run Out ‚Äî Who was involved?'; sel.appendChild(title);
        const sub = document.createElement('div'); sub.style.cssText = 'font-size:12px;color:#999;text-align:center;margin-bottom:10px;'; sub.textContent = '(fielder who threw / direct hit)'; sel.appendChild(sub);
        const lc = document.createElement('div');
        renderPlayerCardList(lc, [...gameState.bowlingTeam.players], fielder => { document.getElementById('wicketModal').classList.remove('active'); recordWicket(outPlayer, 'Run Out', null, fielder); }, new Set(), null);
        sel.appendChild(lc);
        const skipBtn = document.createElement('button'); skipBtn.className = 'modal-back-btn'; skipBtn.style.cssText = 'background:#fff3e0;color:#ff6b35;margin-bottom:6px;'; skipBtn.textContent = 'Skip (no specific fielder)';
        skipBtn.onclick = () => { document.getElementById('wicketModal').classList.remove('active'); recordWicket(outPlayer, 'Run Out', null, null); };
        sel.appendChild(skipBtn);
        const back = document.createElement('button'); back.className = 'modal-back-btn'; back.textContent = '‚Üê Back'; back.onclick = () => wicketStep_RunOutWho(outPlayer); sel.appendChild(back);
    }

    function wicketStep_Fielder(outPlayer, dismissalType, prompt, fielderPool) {
        const sel = document.getElementById('wicketPlayerSelection');
        sel.innerHTML = '';
        const title = document.createElement('div'); title.className = 'modal-step-title'; title.textContent = prompt; sel.appendChild(title);
        const lc = document.createElement('div');
        renderPlayerCardList(lc, fielderPool, fielder => { document.getElementById('wicketModal').classList.remove('active'); recordWicket(outPlayer, dismissalType, fielder, null); }, new Set(), null);
        sel.appendChild(lc);
        const back = document.createElement('button'); back.className = 'modal-back-btn'; back.textContent = '‚Üê Back'; back.onclick = () => wicketStep_HowOut(outPlayer); sel.appendChild(back);
    }

    function handleRetired(player, type) {
        player.isRetired = true; player.retiredType = type;
        const available = gameState.battingTeam.players.filter(p => !p.isOut && !p.isRetired && p !== gameState.striker && p !== gameState.nonStriker);
        if (available.length === 0) { setTimeout(() => endInnings(), 300); return; }
        const modal = document.getElementById('newBatsmanModal');
        const selection = document.getElementById('newBatsmanSelection');
        selection.innerHTML = '';
        const hdr = document.createElement('div'); hdr.className = 'modal-header'; hdr.textContent = 'Replacement Batsman'; selection.appendChild(hdr);
        const sub = document.createElement('div'); sub.style.cssText = 'font-size:13px;color:#ff9800;text-align:center;margin-bottom:14px;'; sub.textContent = player.name + ' retired ‚Äî who comes in?'; selection.appendChild(sub);
        const lc = document.createElement('div');
        renderPlayerCardList(lc, available, p => {
            if (player === gameState.striker) gameState.striker = p; else gameState.nonStriker = p;
            modal.classList.remove('active'); updateScoringDisplay(); saveMatchToFirebase();
        }, new Set(), null);
        selection.appendChild(lc);
        modal.classList.add('active');
    }

    function recordWicket(player, dismissalType, fielder, runOutFielder) {
        takeSnapshot();
        player.isOut = true; player.dismissal = dismissalType || 'Out';
        if (fielder) player.dismissalFielder = fielder.name;
        if (runOutFielder) player.dismissalFielder = runOutFielder.name;
        player.balls++; gameState.wickets++; gameState.bowler.bowlingBalls++;
        if (['Caught','Bowled','LBW','Stumped','Other'].includes(dismissalType)) gameState.bowler.bowlingWickets++;
        gameState.overBalls.push({ value: 'W', class: 'wicket' });

        const active = gameState.battingTeam.players.filter(p => !p.isOut && !p.isRetired).length;
        if (active <= 1 || gameState.wickets >= 10) {
            advanceBall(); updateScoringDisplay(); saveMatchToFirebase();
            setTimeout(() => { if (gameState.innings === 2) showMatchCompleted(); else endInnings(); }, 500);
        } else {
            selectNewBatsman(player); advanceBall(); updateScoringDisplay(); saveMatchToFirebase();
        }
    }

    function selectNewBatsman(outPlayer) {
        const modal = document.getElementById('newBatsmanModal');
        const selection = document.getElementById('newBatsmanSelection');
        selection.innerHTML = '';
        const hdr = document.createElement('div'); hdr.className = 'modal-header'; hdr.textContent = 'New Batsman'; selection.appendChild(hdr);
        const sub = document.createElement('div'); sub.style.cssText = 'font-size:13px;color:#dc3545;text-align:center;margin-bottom:14px;'; sub.textContent = outPlayer.name + ' is out'; selection.appendChild(sub);
        const available = gameState.battingTeam.players.filter(p => !p.isOut && !p.isRetired && p !== gameState.striker && p !== gameState.nonStriker);
        const lc = document.createElement('div');
        renderPlayerCardList(lc, available, p => {
            if (outPlayer === gameState.striker) gameState.striker = p; else gameState.nonStriker = p;
            modal.classList.remove('active'); updateScoringDisplay(); saveMatchToFirebase();
        }, new Set(), null);
        selection.appendChild(lc);
        modal.classList.add('active');
    }

    function advanceBall() {
        gameState.currentBall++;
        if (gameState.currentBall >= 6) {
            gameState.currentBall = 0; gameState.currentOver++; gameState.overBalls = []; swapStrike();
            if (gameState.currentOver >= gameState.overs) { setTimeout(() => endInnings(), 500); }
            else selectNewBowler();
        }
    }

    function selectNewBowler() {
        const modal = document.getElementById('newBowlerModal');
        const selection = document.getElementById('newBowlerSelection');
        selection.innerHTML = '';
        const hdr = document.createElement('div'); hdr.className = 'modal-header'; hdr.textContent = 'Over ' + (gameState.currentOver + 1) + ' ‚Äî Select Bowler'; selection.appendChild(hdr);
        const eligible = gameState.bowlingTeam.players.length > 1
            ? gameState.bowlingTeam.players.filter(p => p !== gameState.bowler)
            : gameState.bowlingTeam.players;
        const lc = document.createElement('div');
        renderPlayerCardList(lc, eligible, p => { gameState.bowler = p; modal.classList.remove('active'); updateScoringDisplay(); saveMatchToFirebase(); }, new Set(), null);
        selection.appendChild(lc);
        modal.classList.add('active');
    }

    function swapStrike() { [gameState.striker, gameState.nonStriker] = [gameState.nonStriker, gameState.striker]; }
    function toggleExtras() { const s = document.getElementById('extrasSection'); s.style.display = s.style.display === 'none' ? 'block' : 'none'; }

    function undoLastBall() {
        if (undoStack.length === 0) { alert('Nothing to undo'); return; }
        gameState = JSON.parse(undoStack.pop());
        if (gameState.striker) gameState.striker = gameState.battingTeam.players.find(p => p.name === gameState.striker.name) || gameState.striker;
        if (gameState.nonStriker) gameState.nonStriker = gameState.battingTeam.players.find(p => p.name === gameState.nonStriker.name) || gameState.nonStriker;
        if (gameState.bowler) gameState.bowler = gameState.bowlingTeam.players.find(p => p.name === gameState.bowler.name) || gameState.bowler;
        updateScoringDisplay(); saveMatchToFirebase();
    }

    function endInnings() {
        if (gameState.innings === 1) {
            gameState.firstInningsScore = gameState.score;
            gameState.firstInningsWickets = gameState.wickets;
            gameState.firstInningsOvers = `${gameState.currentOver}.${gameState.currentBall}`;
            gameState.firstInningsBatting = JSON.parse(JSON.stringify(gameState.battingTeam.players.filter(p => p.balls > 0 || p.isOut || p.isRetired)));
            gameState.firstInningsBowling = JSON.parse(JSON.stringify(gameState.bowlingTeam.players.filter(p => p.bowlingBalls > 0)));

            [gameState.battingTeam, gameState.bowlingTeam] = [gameState.bowlingTeam, gameState.battingTeam];
            gameState.battingTeam.players.forEach(p => { p.runs=0; p.balls=0; p.fours=0; p.sixes=0; p.isOut=false; p.isRetired=false; p.retiredType=null; p.dismissal=null; });
            gameState.bowlingTeam.players.forEach(p => { p.bowlingBalls=0; p.bowlingRuns=0; p.bowlingWickets=0; p.bowlingMaidens=0; });
            gameState.score=0; gameState.wickets=0; gameState.currentOver=0; gameState.currentBall=0; gameState.overBalls=[];
            gameState.innings=2; gameState.striker=null; gameState.nonStriker=null; gameState.bowler=null;

            alert('First innings completed! Starting second innings...');
            selectOpeningBatsmen();
        } else {
            endMatch();
        }
    }

    function showMatchCompleted() {
        gameState.matchStatus = 'completed';
        saveMatchToFirebase();

        let result = '';
        if (gameState.innings === 2) {
            const target = gameState.firstInningsScore + 1;
            result = gameState.score >= target
                ? `${gameState.battingTeam.name} won by ${10 - gameState.wickets} wickets`
                : `${gameState.bowlingTeam.name} won by ${target - gameState.score - 1} runs`;
        }

        // Capture display values BEFORE resetting state
        const teamA = gameState.teamA.name, teamB = gameState.teamB.name;
        const fi_s = gameState.firstInningsScore, fi_w = gameState.firstInningsWickets, fi_o = gameState.firstInningsOvers;
        const si_s = gameState.score, si_w = gameState.wickets, si_o = `${gameState.currentOver}.${gameState.currentBall}`;

        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        const oldScreen = document.getElementById('matchCompletedScreen');
        if (oldScreen) oldScreen.remove();

        const completedScreen = document.createElement('div');
        completedScreen.id = 'matchCompletedScreen';
        completedScreen.style.cssText = 'padding: 40px 20px; text-align: center; min-height: calc(100vh - 100px);';
        completedScreen.innerHTML = `
            <div style="margin-top: 60px;">
                <div style="font-size: 80px; margin-bottom: 20px;">üèÜ</div>
                <h2 style="font-size: 32px; color: #ff6b35; margin-bottom: 20px; font-weight: bold;">Match Completed!</h2>
                <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); margin-bottom: 30px;">
                    <div style="font-size: 24px; font-weight: bold; color: #333; margin-bottom: 15px;">${result}</div>
                    <div style="font-size: 18px; color: #666; margin-bottom: 10px;">${teamA} vs ${teamB}</div>
                    <div style="font-size: 16px; color: #999;">First Innings: ${fi_s}/${fi_w} (${fi_o})</div>
                    <div style="font-size: 16px; color: #999;">Second Innings: ${si_s}/${si_w} (${si_o})</div>
                </div>
                <button onclick="goHome()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 18px 50px; border-radius: 50px; font-size: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 5px 25px rgba(40,167,69,0.4);">
                    üè† Go Home
                </button>
            </div>`;

        document.querySelector('.container').appendChild(completedScreen);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  FIX: goHome resets ALL state before going home
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function goHome() {
        const completedScreen = document.getElementById('matchCompletedScreen');
        if (completedScreen) completedScreen.remove();
        resetGameState();  // ‚Üê THE KEY FIX
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('homeScreen').classList.add('active');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  FIX: showHome also clears stale state when
    //       called outside of an active live match
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showHome() {
        const completedScreen = document.getElementById('matchCompletedScreen');
        if (completedScreen) completedScreen.remove();
        if (gameState.matchStatus !== 'live') {
            resetGameState();
        }
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('homeScreen').classList.add('active');
    }

    function endMatch() { showMatchCompleted(); }

    function showScorecard() {
        const content = document.getElementById('scorecardContent');
        let html = `<div style="text-align:center;margin-bottom:20px;"><strong>${gameState.teamA.name}</strong> vs <strong>${gameState.teamB.name}</strong></div>`;
        if (gameState.innings === 2) {
            const t = gameState.firstInningsBattingTeam === 'teamA' ? gameState.teamA : gameState.teamB;
            html += `<div style="font-weight:bold;color:#ff6b35;margin:10px 0;">${t.name} - 1st Innings</div>`;
            html += `<div style="text-align:center;font-size:24px;color:#ff6b35;margin:10px 0;"><strong>${gameState.firstInningsScore}/${gameState.firstInningsWickets}</strong></div>`;
            html += `<div style="text-align:center;color:#666;margin-bottom:20px;">Overs: ${gameState.firstInningsOvers}</div>`;
        }
        html += `<div style="font-weight:bold;color:#ff6b35;margin:10px 0;">${gameState.battingTeam.name} - ${gameState.innings===2?'2nd ':''} Batting</div>`;
        html += '<table style="width:100%;border-collapse:collapse;"><thead><tr style="background:#f8f9fa;"><th style="padding:8px;text-align:left;">Batsman</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th></tr></thead><tbody>';
        gameState.battingTeam.players.forEach(p => {
            if (p.balls > 0 || p.isOut) {
                const sr = p.balls > 0 ? ((p.runs/p.balls)*100).toFixed(1) : '0.0';
                html += `<tr style="border-bottom:1px solid #e0e0e0;"><td style="padding:8px;">${p.name}${p.isOut?'<span style="color:#dc3545;"> out</span>':''}</td><td style="text-align:center;"><strong>${p.runs}</strong></td><td style="text-align:center;">${p.balls}</td><td style="text-align:center;">${p.fours||0}</td><td style="text-align:center;">${p.sixes||0}</td><td style="text-align:center;">${sr}</td></tr>`;
            }
        });
        html += `</tbody></table><div style="margin:15px 0;text-align:center;color:#666;">Total: ${gameState.score}/${gameState.wickets} (${gameState.currentOver}.${gameState.currentBall} overs)</div>`;
        content.innerHTML = html;
        document.getElementById('scorecardModal').classList.add('active');
    }

    function updateScoringDisplay() {
        document.getElementById('vsTeams').textContent = `${gameState.teamA.name} vs ${gameState.teamB.name}`;
        document.getElementById('inningsBadge').textContent = `${gameState.innings}${gameState.innings===1?'st':'nd'} Innings - ${gameState.battingTeam.name}`;
        document.getElementById('mainScore').textContent = `${gameState.score}/${gameState.wickets}`;
        document.getElementById('oversInfo').textContent = `Overs: ${gameState.currentOver}.${gameState.currentBall} / ${gameState.overs}`;
        const targetInfo = document.getElementById('targetInfo');
        if (gameState.innings === 2) {
            targetInfo.classList.add('show');
            const req = gameState.firstInningsScore + 1 - gameState.score;
            const ballsLeft = (gameState.overs*6) - (gameState.currentOver*6 + gameState.currentBall);
            document.getElementById('targetRuns').textContent = req > 0 ? `Need ${req} runs to win` : `Target achieved!`;
            document.getElementById('targetBalls').textContent = `${ballsLeft} balls remaining`;
        } else { targetInfo.classList.remove('show'); }
        document.getElementById('striker1Name').innerHTML = `<span class="strike-indicator" style="display:inline-block;"></span>${gameState.striker.name}`;
        document.getElementById('striker1Stats').textContent = `${gameState.striker.runs}(${gameState.striker.balls})`;
        document.getElementById('striker2Name').innerHTML = `<span class="strike-indicator" style="display:none;"></span>${gameState.nonStriker.name}`;
        document.getElementById('striker2Stats').textContent = `${gameState.nonStriker.runs}(${gameState.nonStriker.balls})`;
        document.getElementById('bowlerNameDisplay').textContent = gameState.bowler.name;
        document.getElementById('bowlerStatsDisplay').textContent = `${gameState.bowler.bowlingWickets}-${gameState.bowler.bowlingRuns} (${Math.floor(gameState.bowler.bowlingBalls/6)}.${gameState.bowler.bowlingBalls%6})`;
        const bc = document.getElementById('currentOverBalls');
        bc.innerHTML = '';
        if (gameState.overBalls.length === 0) { bc.innerHTML = '<div class="ball-dot">-</div>'; }
        else { gameState.overBalls.forEach(b => { const d = document.createElement('div'); d.className = `ball-dot ${b.class}`; d.textContent = b.value; bc.appendChild(d); }); }
        const panel = document.getElementById('inlineScorecardPanel');
        if (panel && panel.classList.contains('open')) renderInlineScorecard();
    }

    function toggleInlineScorecard() {
        const panel = document.getElementById('inlineScorecardPanel');
        panel.classList.toggle('open');
        if (panel.classList.contains('open')) renderInlineScorecard();
    }

    function renderInlineScorecard() {
        const content = document.getElementById('inlineScorecardContent');
        let html = `<div class="sc-section-label">üèè Batting ‚Äî ${gameState.battingTeam.name}</div>`;
        html += `<table class="sc-table"><thead><tr><th>Batsman</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th></tr></thead><tbody>`;
        gameState.battingTeam.players.forEach(p => {
            if (p.balls===0 && !p.isOut && !p.isRetired) return;
            const isS = p===gameState.striker, isNS = p===gameState.nonStriker;
            const sr = p.balls>0 ? ((p.runs/p.balls)*100).toFixed(0) : '-';
            let badge = '';
            if (p.isOut) badge = `<span class="sc-badge out">${p.dismissal||'OUT'}</span>`;
            else if (p.isRetired) badge = `<span class="sc-badge retired">${p.retiredType||'RETIRED'}</span>`;
            else if (isS) badge = `<span class="sc-badge batting">*</span>`;
            else if (isNS) badge = `<span class="sc-badge batting">‚Ä†</span>`;
            html += `<tr class="${(isS||isNS)?'sc-active':''}"><td>${p.name}${badge}</td><td><strong>${p.runs}</strong></td><td>${p.balls}</td><td>${p.fours||0}</td><td>${p.sixes||0}</td><td>${sr}</td></tr>`;
        });
        html += '</tbody></table>';
        html += `<div class="sc-section-label">‚öæ Bowling ‚Äî ${gameState.bowlingTeam.name}</div>`;
        html += `<table class="sc-table"><thead><tr><th>Bowler</th><th>O</th><th>R</th><th>W</th><th>Eco</th></tr></thead><tbody>`;
        gameState.bowlingTeam.players.forEach(p => {
            if (p.bowlingBalls===0) return;
            const isC = p===gameState.bowler;
            const overs = `${Math.floor(p.bowlingBalls/6)}.${p.bowlingBalls%6}`;
            const eco = p.bowlingBalls>0 ? (p.bowlingRuns/(p.bowlingBalls/6)).toFixed(1) : '-';
            html += `<tr class="${isC?'sc-active':''}"><td>${p.name}${isC?' <span class="sc-badge batting">‚óè</span>':''}</td><td>${overs}</td><td>${p.bowlingRuns}</td><td><strong style="color:#dc3545;">${p.bowlingWickets}</strong></td><td>${eco}</td></tr>`;
        });
        html += '</tbody></table>';
        content.innerHTML = html;
    }

    function saveMatchToFirebase() {
        if (!database || !currentMatchId) return;
        database.ref('matches/' + currentMatchId).set({ ...gameState, lastUpdated: Date.now(), matchId: currentMatchId })
            .then(() => saveActiveMatch())
            .catch(e => console.error('Error saving match data:', e));
    }

    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    // ‚îÄ‚îÄ Team Management ‚îÄ‚îÄ
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  PLAYER PHOTO UPLOAD
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const photoCache = {};
    let _photoPickerAvatar = null;   // the avatar DOM element currently being updated
    let _photoPickerName   = null;   // player name currently being updated

    function getPlayerInitials(name) {
        return (name || '?').split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
    }

    function encodePlayerKey(name) {
        return (name || '').replace(/[.#$[\]/\s]/g, '_');
    }

    function fetchPlayerPhoto(playerName, callback) {
        if (photoCache[playerName]) { callback(photoCache[playerName]); return; }
        if (!database) { callback(null); return; }
        database.ref('playerPhotos/' + encodePlayerKey(playerName)).once('value')
            .then(snap => {
                const url = snap.val();
                if (url) photoCache[playerName] = url;
                callback(url || null);
            })
            .catch(() => callback(null));
    }

    function setAvatarPhoto(avatarEl, url) {
        if (!avatarEl) return;
        if (url) {
            avatarEl.innerHTML = `<img src="${url}" alt="photo"><div class="avatar-cam-overlay">üì∑</div>`;
        } else {
            const name = avatarEl.dataset.playerName || '';
            avatarEl.innerHTML = `${getPlayerInitials(name)}<div class="avatar-cam-overlay">üì∑</div>`;
        }
    }

    function buildPlayerAvatar(player) {
        const avatar = document.createElement('div');
        avatar.className = 'player-card-avatar';
        avatar.dataset.playerName = player.name;
        avatar.title = 'Tap to update photo';
        avatar.innerHTML = `${getPlayerInitials(player.name)}<div class="avatar-cam-overlay">üì∑</div>`;

        fetchPlayerPhoto(player.name, url => {
            if (url) setAvatarPhoto(avatar, url);
        });

        avatar.addEventListener('click', e => {
            e.stopPropagation();
            e.preventDefault();
            openPhotoPicker(player.name, avatar);
        });
        return avatar;
    }

    function openPhotoPicker(playerName, avatarEl) {
        _photoPickerName   = playerName;
        _photoPickerAvatar = avatarEl;
        document.getElementById('photoPickerPlayerName').textContent = playerName;
        document.getElementById('photoPickerSheet').classList.add('active');
    }

    function closePhotoPicker() {
        document.getElementById('photoPickerSheet').classList.remove('active');
        _photoPickerName   = null;
        _photoPickerAvatar = null;
    }

    // source: 'camera' | 'gallery'
    function pickPhoto(source) {
        // Capture before close clears them
        const playerName = _photoPickerName;
        const avatarEl   = _photoPickerAvatar;
        closePhotoPicker();
        if (!playerName) return;

        // Build hidden file input
        const input = document.createElement('input');
        input.type   = 'file';
        input.accept = 'image/*';
        if (source === 'camera') {
            input.capture = 'environment'; // rear camera; use 'user' for selfie
        }
        // No capture attr for gallery ‚Äî lets user pick normally

        input.onchange = function() {
            const file = input.files && input.files[0];
            if (!file) return;
            handlePhotoFile(file, playerName, avatarEl);
        };

        // Must be in DOM briefly on iOS for click to work
        input.style.cssText = 'position:fixed;opacity:0;top:0;left:0;width:1px;height:1px;';
        document.body.appendChild(input);
        setTimeout(() => {
            input.click();
            setTimeout(() => document.body.removeChild(input), 5000);
        }, 100);
    }

    function handlePhotoFile(file, playerName, avatarEl) {
        // Find or create progress label under the avatar's parent row
        const row = avatarEl ? avatarEl.closest('.player-card-row') : null;
        let progressEl = row ? row.querySelector('.photo-upload-progress') : null;
        if (!progressEl && row) {
            progressEl = document.createElement('div');
            progressEl.className = 'photo-upload-progress';
            row.appendChild(progressEl);
        }
        const setProgress = t => { if (progressEl) progressEl.textContent = t; };

        setProgress('Compressing‚Ä¶');
        compressImage(file, function(blob) {
            if (!blob) { setProgress('‚ùå Compression failed'); return; }
            setProgress('Uploading‚Ä¶');
            const key = encodePlayerKey(playerName);
            const storageRef = storage.ref('playerPhotos/' + key + '.jpg');
            const task = storageRef.put(blob, { contentType: 'image/jpeg' });

            task.on('state_changed',
                snap => {
                    const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
                    setProgress(`Uploading‚Ä¶ ${pct}%`);
                },
                err => {
                    console.error('Upload error:', err);
                    setProgress('‚ùå Upload failed');
                    setTimeout(() => { if (progressEl) progressEl.textContent = ''; }, 3000);
                },
                () => {
                    task.snapshot.ref.getDownloadURL().then(url => {
                        database.ref('playerPhotos/' + key).set(url);
                        photoCache[playerName] = url;
                        if (avatarEl) setAvatarPhoto(avatarEl, url);
                        setProgress('‚úÖ Photo saved!');
                        setTimeout(() => { if (progressEl) progressEl.textContent = ''; }, 2500);
                    });
                }
            );
        });
    }

    function compressImage(file, callback) {
        const reader = new FileReader();
        reader.onerror = () => callback(null);
        reader.onload = function(e) {
            const img = new Image();
            img.onerror = () => callback(null);
            img.onload = function() {
                const MAX = 400;
                let w = img.width, h = img.height;
                if (w > h) { if (w > MAX) { h = Math.round(h * MAX / w); w = MAX; } }
                else       { if (h > MAX) { w = Math.round(w * MAX / h); h = MAX; } }
                const canvas = document.createElement('canvas');
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                canvas.toBlob(blob => callback(blob), 'image/jpeg', 0.75);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function saveTeamToFirebase(teamName, players) {
        if (!teamName || !players || players.length===0 || !database) return;
        database.ref('teams/' + teamName).set({ name: teamName, players, lastUsed: Date.now() }).catch(console.error);
    }

    function getSavedTeams(callback) {
        if (!database) { callback({}); return; }
        database.ref('teams').once('value').then(s => callback(s.val()||{})).catch(() => callback({}));
    }

    function deleteTeam(teamName) {
        if (confirm(`Delete team "${teamName}"?`)) {
            database.ref('teams/' + teamName).remove().then(() => showSavedTeams()).catch(() => alert('Failed to delete team'));
        }
    }

    function populateSavedTeamsDropdowns() {
        getSavedTeams(savedTeams => {
            const names = Object.keys(savedTeams).sort();
            ['A','B'].forEach(t => {
                const sel = document.getElementById(`team${t}LoadSelect`);
                if (!sel) return;
                sel.innerHTML = '<option value="">-- Select a saved team --</option>';
                names.forEach(n => { const o = document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); });
            });
        });
    }

    function loadSavedTeam(team, teamName) {
        if (!teamName) return;
        getSavedTeams(savedTeams => {
            const td = savedTeams[teamName]; if (!td) return;
            document.getElementById(`team${team}Name`).value = td.name;
            td.players.forEach((n, i) => { const inp = document.getElementById(`team${team}Player${i+1}`); if (inp) inp.value = n; });
            if (!document.getElementById(`team${team}Players`).classList.contains('show')) togglePlayers(team);
        });
    }

    function showSavedTeams() {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('savedTeamsScreen').classList.add('active');
        getSavedTeams(savedTeams => {
            const list = document.getElementById('savedTeamsList');
            if (Object.keys(savedTeams).length===0) { list.innerHTML = `<div style="text-align:center;padding:40px;color:#999;"><div style="font-size:60px;margin-bottom:20px;">üìã</div><p>No saved teams yet</p></div>`; return; }
            list.innerHTML = Object.values(savedTeams).sort((a,b)=>b.lastUsed-a.lastUsed).map(t => `
                <div style="background:white;border:2px solid #e0e0e0;border-radius:12px;padding:15px;margin-bottom:15px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                        <div><div style="font-size:18px;font-weight:bold;color:#333;">${t.name}</div><div style="font-size:12px;color:#999;">Last used: ${new Date(t.lastUsed).toLocaleDateString()}</div></div>
                        <button onclick="deleteTeam('${t.name}')" style="background:#dc3545;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">Delete</button>
                    </div>
                    <div style="font-size:14px;color:#666;"><strong>Players (${t.players.length}):</strong> ${t.players.join(', ')}</div>
                </div>`).join('');
        });
    }

    // ‚îÄ‚îÄ Match History ‚îÄ‚îÄ
    function showMatchHistory() {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('matchHistoryScreen').classList.add('active');
        if (!database) { document.getElementById('matchHistoryList').innerHTML = `<div style="text-align:center;padding:40px;color:#999;"><p>Firebase not initialized</p></div>`; return; }
        document.getElementById('matchHistoryList').innerHTML = `<div style="text-align:center;padding:40px;color:#999;"><p>Loading...</p></div>`;
        database.ref('matches').orderByChild('lastUpdated').limitToLast(20).once('value')
            .then(snapshot => { const m=[]; snapshot.forEach(c=>m.push(c.val())); displayMatchHistory(m.reverse()); })
            .catch(() => { document.getElementById('matchHistoryList').innerHTML = `<div style="text-align:center;padding:40px;color:#999;"><p>Error loading matches</p></div>`; });
    }

    function displayMatchHistory(matches) {
        const list = document.getElementById('matchHistoryList');
        const completed = matches.filter(m => m.matchStatus==='completed');
        if (completed.length===0) { list.innerHTML = `<div style="text-align:center;padding:40px;color:#999;"><div style="font-size:60px;margin-bottom:20px;">üìä</div><p>No completed matches yet</p></div>`; return; }
        list.innerHTML = completed.map(match => {
            const target = match.firstInningsScore+1;
            const result = match.innings===2 ? (match.score>=target ? `${match.battingTeam.name} won by ${10-match.wickets} wickets` : `${match.bowlingTeam.name} won by ${target-match.score-1} runs`) : '';
            return `<div style="background:white;border:2px solid #e0e0e0;border-radius:12px;padding:15px;margin-bottom:15px;">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;">
                    <div style="flex:1;">
                        <div style="font-size:16px;font-weight:bold;color:#333;margin-bottom:5px;">${match.teamA.name} vs ${match.teamB.name}</div>
                        <div style="font-size:12px;color:#999;margin-bottom:8px;">${new Date(match.lastUpdated).toLocaleString()}</div>
                        <div style="font-size:14px;color:#ff6b35;font-weight:bold;margin-bottom:5px;">${result}</div>
                        <div style="font-size:13px;color:#666;">1st Innings: ${match.firstInningsScore}/${match.firstInningsWickets} (${match.firstInningsOvers})<br>2nd Innings: ${match.score}/${match.wickets} (${match.currentOver}.${match.currentBall})</div>
                    </div>
                    <button onclick="deleteMatch('${match.matchId}')" style="background:#dc3545;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;margin-left:10px;">Delete</button>
                </div>
            </div>`;
        }).join('');
    }

    function deleteMatch(matchId) {
        if (confirm('Delete this match?')) {
            database.ref('matches/' + matchId).remove().then(() => showMatchHistory()).catch(() => alert('Failed to delete match'));
        }
    }

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js').catch(()=>{}); });
    }

    window.onload = init;
</script>

<!-- Photo Picker Bottom Sheet -->
<div class="photo-picker-sheet" id="photoPickerSheet" onclick="if(event.target===this)closePhotoPicker()">
    <div class="photo-picker-inner">
        <div class="photo-picker-title">Update Profile Photo</div>
        <div class="photo-picker-player" id="photoPickerPlayerName"></div>
        <button class="photo-picker-btn camera" onclick="pickPhoto('camera')">
            <div class="btn-icon">üì∑</div>
            <div>
                <div>Take Photo</div>
                <div style="font-size:12px;font-weight:normal;color:#999;margin-top:2px;">Open camera</div>
            </div>
        </button>
        <button class="photo-picker-btn gallery" onclick="pickPhoto('gallery')">
            <div class="btn-icon">üñºÔ∏è</div>
            <div>
                <div>Choose from Gallery</div>
                <div style="font-size:12px;font-weight:normal;color:#999;margin-top:2px;">Pick existing photo</div>
            </div>
        </button>
        <button class="photo-picker-cancel" onclick="closePhotoPicker()">Cancel</button>
    </div>
</div>
```

</body>
</html>
